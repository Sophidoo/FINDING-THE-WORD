{% extends "base.html" %}
{% block title %}Find the Word - Dashboard{% endblock %}


{% block content %}
<div class="dashboard-container">

    <!-- Header -->
    <header class="dashboard-header">
        <div class="dashboard-logo">
            <div class="logo-box">F</div>
            <h1 class="dashboard-title">FIND THE WORD</h1>
        </div>
        <div class="header-actions">
            {% if current_user.is_authenticated %}
            <button id="playNowBtn" class="play-now-btn">PLAY NOW</button>
            <div class="user-info">
                <div class="user-avatar">{{ current_user.username[0].upper() }}</div>
                <span class="user-name">{{ current_user.username }}</span>
            </div>
            {% else %}
            <a href="/login" class="play-now-btn">LOGIN TO PLAY</a>
            {% endif %}
        </div>
    </header>

    <!-- Player Stats (Visible before game) -->
    <div id="playerStatsSection" class="player-stats-section">
        <div class="player-stats-card horizontal">
            <div class="player-stats-header">
                <div class="player-avatar-large">{{ current_user.username[0].upper() if current_user.is_authenticated else 'P' }}</div>
                <div class="player-info-large">
                    <h3 id="playerUsername">{{ current_user.username if current_user.is_authenticated else 'Guest' }}</h3>
                    <p class="player-rank-badge">Rank #<span id="playerRank">--</span></p>
                </div>
            </div>
            <div class="stats-grid horizontal">
                <div class="stat-box"><div class="stat-box-value" id="totalGames">0</div><div class="stat-box-label">Total Games</div></div>
                <div class="stat-box"><div class="stat-box-value" id="completedGames">0</div><div class="stat-box-label">Completed</div></div>
                <div class="stat-box"><div class="stat-box-value" id="bestScore">0</div><div class="stat-box-label">Best Score</div></div>
                <div class="stat-box"><div class="stat-box-value" id="avgScore">0</div><div class="stat-box-label">Avg Score</div></div>
            </div>
            <div class="completion-rate horizontal">
                <div class="completion-rate-label">
                    <span>Completion Rate</span>
                    <span id="completionRatePercent">0%</span>
                </div>
                <div class="completion-rate-bar">
                    <div class="completion-rate-fill" id="completionRateFill" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Area -->
    <div id="gameArea" class="hidden">
        <div class="game-layout">
            <div class="game-panel">
                <div class="game-controls">
                    <div class="difficulty-selector">
                        <button class="difficulty-btn easy active" data-difficulty="1">Easy</button>
                        <button class="difficulty-btn medium" data-difficulty="2">Medium</button>
                        <button class="difficulty-btn hard" data-difficulty="3">Hard</button>
                    </div>
                    <div class="game-actions">
                        <button class="action-btn primary" id="newGameBtn">New Game</button>
                        <button class="action-btn danger" id="endGameBtn">End Game</button>
                    </div>
                </div>

                <div class="word-grid-container">
                    <div class="word-grid easy" id="wordGrid"></div>
                </div>

                <div class="words-to-find">
                    <h3>Words to Find</h3>
                    <div class="words-list" id="wordsList"></div>
                </div>
            </div>

            <aside class="side-panel">
                <div class="stats-card">
                    <h3>Game Stats</h3>
                    <div class="stat-item"><span class="stat-label">Time</span><span class="stat-value timer" id="timer">00:00</span></div>
                    <div class="stat-item"><span class="stat-label">Score</span><span class="stat-value score" id="score">0</span></div>
                    <div class="stat-item"><span class="stat-label">Found</span><span class="stat-value" id="foundCount">0/0</span></div>
                    <div class="progress-container">
                        <div class="progress-label"><span>Progress</span><span id="progressPercent">0%</span></div>
                        <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width: 0%"></div></div>
                    </div>
                </div>

                <div class="achievements-card">
                    <h3>Word Information</h3>
                    <div id="wordInfoContent">
                        <p style="text-align:center;color:#aaa;padding:2rem 1rem;">Select a word to see details!</p>
                    </div>
                    <button class="hint-btn" id="hintBtn">Use Hint</button>
                    <span class="hint-count">Hints: <span id="hintCount">3</span></span>
                </div>
            </aside>
        </div>
    </div>

    <!-- Leaderboard -->
    <section class="leaderboard-section" id="leaderboardSection">
        <h2>Leaderboard</h2>
        <div class="leaderboard-table" id="leaderboardTable">
            <!-- Filled by JS -->
        </div>
    </section>
</div>

<div id="gameCompletionModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">üéâ CONGRATULATIONS! üéâ</h2>
        </div>
        <div class="modal-body">
            <p id="modalMessage" class="modal-message"></p>
            <div class="stats-display">
                <div class="stat-row">
                    <span class="stat-label">üèÜ Score:</span>
                    <span class="stat-value" id="modalScore">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">üìù Total Words:</span>
                    <span class="stat-value" id="modalTotalWords">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">‚úì Words Found:</span>
                    <span class="stat-value" id="modalWordsFound">0</span>
                </div>
                <div class="stat-row" id="missedWordsRow">
                    <span class="stat-label">‚è±Ô∏è Time Taken:</span>
                    <span class="stat-value" id="modalTimeTaken">0</span>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn" id="viewLeaderboardBtn">View Leaderboard</button>
            <button class="modal-btn" id="closeCompletionModal">Close</button>
        </div>
    </div>
</div>

<!-- End Game Confirmation Modal -->
<div id="endGameModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>‚ö†Ô∏è End Game</h2>
        </div>
        <div class="modal-body">
            <p class="modal-message">Are you sure you want to end the game?</p>
            <p class="modal-submessage">Your progress will be lost.</p>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" id="cancelEndGame">No, Keep Playing</button>
            <button class="modal-btn danger" id="confirmEndGame">Yes, End Game</button>
        </div>
    </div>
</div>

<!-- Notification -->
<div id="notificationAlert" class="notification-alert"><span id="notificationMessage"></span></div>

{% endblock %}

{% block scripts %}
<script>
    let currentGame = null;
    let timerInterval = null;
    let seconds = 0;
    let hintsUsed = 0;
    let timeRemaining = 0;

    async function apiCall(url, options = {}) {
        const res = await fetch(url, {
            method: options.method || 'GET',
            headers: { 'Content-Type': 'application/json' },
            body: options.body,
            credentials: 'include'
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Error');
        return data;
    }
    // === LOAD PLAYER STATS FROM BACKEND ===
    async function loadPlayerStats() {
        try {
            const stats = await apiCall('/api/leaderboard/user-stats');
            console.log(stats)
            // Update all the fields
            document.getElementById('playerUsername').textContent = stats.username || 'Guest';
            document.getElementById('totalGames').textContent = stats.total_games;
            document.getElementById('completedGames').textContent = stats.completed_games;

            // Best score overall (from any level)
            const bestOverall = Math.max(
                stats.best_scores[1]?.score || 0,
                stats.best_scores[2]?.score || 0,
                stats.best_scores[3]?.score || 0
            );
            document.getElementById('bestScore').textContent = bestOverall;

            document.getElementById('avgScore').textContent = Math.round(stats.average_score);

            // Completion rate
            const completionRate = stats.completion_rate.replace('%', '');
            document.getElementById('completionRatePercent').textContent = stats.completion_rate;
            document.getElementById('completionRateFill').style.width = completionRate + '%';

            // Optional: Show rank (you can extend the API later if you want real rank)
            document.getElementById('playerRank').textContent = '--'; // or calculate from leaderboard

        } catch (err) {
            console.error('Failed to load player stats:', err);
            // Keep defaults (0s) if offline or error
        }
    }
    async function showGameCompletionModal() {
        if (!currentGame) return;

        try {
            // Call the end game API to get final accurate stats
            const result = await apiCall('/api/game/end', {
                method: 'POST',
                body: JSON.stringify({ session_id: currentGame.session_id })
            });
            console.log(result)

            // Format time_taken (assuming it's in seconds)
            const mins = String(Math.floor(result.time_taken / 60)).padStart(2, '0');
            const secs = String(result.time_taken % 60).padStart(2, '0');
            const timeFormatted = `${mins}:${secs}`;

            // Update modal with real backend data
            document.getElementById('modalTitle').textContent = 'CONGRATULATIONS!';
            document.getElementById('modalMessage').textContent = result.message || 'You completed the game!';

            document.getElementById('modalScore').textContent = result.final_score;
            document.getElementById('modalTotalWords').textContent = result.total_words;
            document.getElementById('modalWordsFound').textContent = result.words_found;
            document.getElementById('modalCompletionRate').textContent = result.completion_rate;
            document.getElementById('modalTimeTaken').textContent = result.time_taken;

            // Finally show the modal
            document.getElementById('gameCompletionModal').classList.add('show');

            // Important: Mark game as ended so we don't call /end twice
            currentGame = null;

        } catch (err) {
            showNotification('Error saving score: ' + err.message);
            console.error(err);
            // Still show a basic modal even if API fails
            document.getElementById('modalMessage').textContent = 'You won! (Score may not be saved)';
            document.getElementById('gameCompletionModal').classList.add('show');
        }
    }

    function showEndGameConfirmation() {
        document.getElementById('endGameModal').classList.add('show');
    }

    // === UPDATED endGame (only called when player confirms or quits) ===
    function endGame() {
        if (timerInterval) clearInterval(timerInterval);
       document.getElementById('gameArea').classList.add('hidden');
       document.getElementById('playerStatsSection').style.display = 'block';
       document.getElementById('leaderboardSection').style.display = 'block';
       loadPlayerStats();
    }
    function clearGridSelection() {
        document.querySelectorAll('.grid-cell.selected, .grid-cell.found').forEach(cell => {
            cell.classList.remove('selected');
        });
    }
    function startGame() {
        const level = document.querySelector('.difficulty-btn.active').dataset.difficulty;
        apiCall('/api/game/start', { method: 'POST', body: JSON.stringify({ level_id: parseInt(level) }) })
            .then(game => {
            console.log(game)
                currentGame = game;
                renderGrid(game.grid);
                renderWordList(game.words);
                startTimer();
                updateStats(0, game.total_words);
                hintsUsed = 0;
                document.getElementById('hintCount').textContent = 3;
                document.getElementById('score').textContent = 0;
                document.getElementById('gameArea').classList.remove('hidden');
                document.getElementById('playerStatsSection').style.display = 'none';
                document.getElementById('leaderboardSection').style.display = 'none';
            })
            .catch(err => showNotification('Error: ' + err.message));
    }

    function renderGrid(grid) {
        const container = document.getElementById('wordGrid');
        container.innerHTML = '';
        container.className = `word-grid ${grid.length === 8 ? 'easy' : grid.length === 10 ? 'medium' : 'hard'}`;
        grid.forEach((row, y) => {
            row.forEach((letter, x) => {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                cell.textContent = letter;
                cell.dataset.x = x;
                cell.dataset.y = y;
                container.appendChild(cell);
            });
        });
    }


    function renderWordList(words) {
        const list = document.getElementById('wordsList');
        list.innerHTML = '';
        words.forEach(word => {
            const item = document.createElement('div');
            item.className = 'word-item';
            item.textContent = word;
            item.id = `word-${word}`;
            list.appendChild(item);
        });
    }

    function markWordFound(word) {
        const el = document.getElementById(`word-${word}`);
        if (el) el.classList.add('found');
    }

    function updateStats(found, total) {
        document.getElementById('foundCount').textContent = `${found}/${total}`;
        const progress = total > 0 ? (found / total) * 100 : 0;
        document.getElementById('progressFill').style.width = progress + '%';
        document.getElementById('progressPercent').textContent = Math.round(progress) + '%';

        // Pure 100 points per word
        document.getElementById('score').textContent = (found * 100);
    }

      // Add this global variable at the top with others

function startTimer() {
    if (!currentGame?.time_limit) return;

    timeRemaining = currentGame.time_limit;  // e.g. 480 seconds
    if (timerInterval) clearInterval(timerInterval);

    // Update display immediately
    updateTimerDisplay();

    timerInterval = setInterval(() => {
        timeRemaining--;
        updateTimerDisplay();

        // Time's up!
        if (timeRemaining <= 0) {
            clearInterval(timerInterval);
            document.getElementById('timer').textContent = "00:00";
            showNotification("‚è∞ Time's Up!");
            showGameCompletionModal();  // End game automatically
        }
    }, 1000);
}

function updateTimerDisplay() {
    const mins = String(Math.floor(timeRemaining / 60)).padStart(2, '0');
    const secs = String(timeRemaining % 60).padStart(2, '0');
    document.getElementById('timer').textContent = `${mins}:${secs}`;

    // Optional: turn red when < 30 seconds
    const timerEl = document.getElementById('timer');
    if (timeRemaining <= 30) {
        timerEl.style.color = '#e74c3c';
        timerEl.style.fontWeight = 'bold';
    } else {
        timerEl.style.color = '';
        timerEl.style.fontWeight = '';
    }
}

    document.getElementById('hintBtn').onclick = async () => {
        if (!currentGame || hintsUsed >= 3) return showNotification('No hints left!');
        try {
            const hint = await apiCall('/api/game/hint', {
                method: 'POST',
                body: JSON.stringify({ session_id: currentGame.session_id })
            });
            showNotification(`Hint: Starts with "${hint.hint}"`);
            hintsUsed++;
            document.getElementById('hintCount').textContent = 3 - hintsUsed;
        } catch (err) { showNotification(err.message); }
    };

    // Drag selection
    let selecting = false;
    let selected = [];

    document.getElementById('wordGrid').addEventListener('mousedown', e => {
        if (!e.target.classList.contains('grid-cell')) return;
        selecting = true;
        selected = [e.target];
        e.target.classList.add('selected');
    });
    document.getElementById('wordGrid').addEventListener('mousemove', e => {
        if (!selecting || !e.target.classList.contains('grid-cell')) return;
        if (!selected.includes(e.target)) {
            selected.push(e.target);
            e.target.classList.add('selected');
        }
    });
    document.addEventListener('mouseup', () => {
        if (!selecting) return;
        selecting = false;
        const word = selected.map(c => c.textContent).join('');
        if (word.length < 3) {
            selected.forEach(c => c.classList.remove('selected'));
            selected = [];
            return;
        }
        submitWord(word);
    });

    async function submitWord(word) {
        try {
            const result = await apiCall('/api/game/validate', {
                method: 'POST',
                body: JSON.stringify({ session_id: currentGame.session_id, word })
            });
            console.log(result)
            if (result.valid && !result.already_found) {
                selected.forEach(c => c.classList.add('found'));
                markWordFound(word);

                // Use backend score (guaranteed correct)
                document.getElementById('score').textContent = result.score;
                updateStats(result.found_count, result.total_words);

                showNotification(`+100! "${word}" found!`);

                if (result.found_count === result.total_words) {
                    clearInterval(timerInterval);
                    setTimeout(showGameCompletionModal, 800);  // small delay for celebration
                }
            } else {
                showNotification(result.already_found ? 'Already found!' : 'Not in list!');
            }
        } catch (err) {
            showNotification('Error: ' + err.message);
        } finally {
            selected.forEach(c => c.classList.remove('selected'));
            selected = [];
        }
    }



    function showNotification(msg) {
        const el = document.getElementById('notificationMessage');
        el.textContent = msg;
        const alert = document.getElementById('notificationAlert');
        alert.classList.add('show');
        setTimeout(() => alert.classList.remove('show'), 3000);
    }

    // Button Events
    document.getElementById('playNowBtn')?.addEventListener('click', startGame);
    document.getElementById('newGameBtn').addEventListener('click', startGame);
    document.getElementById('endGameBtn').addEventListener('click', showEndGameConfirmation);
    document.querySelectorAll('.difficulty-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });

    // Load leaderboard on start
    async function loadLeaderboard() {
        try {
            const data = await apiCall('/api/leaderboard/leaderboard');
            const table = document.getElementById('leaderboardTable');
            table.innerHTML = `<div class="leaderboard-row header">
                <div class="rank">Rank</div>
                <div class="player-name">Player</div>
                <div class="player-score">Score</div>
                <div class="player-time">Time</div>
            </div>`;
            data.forEach((p, i) => {
                const row = document.createElement('div');
                row.className = 'leaderboard-row' + (p.is_current ? ' current-player' : '');
                row.innerHTML = `<div class="rank ${i < 3 ? 'top' : ''}">${i + 1}</div>
                    <div class="player-name">${p.username} ${p.is_current ? '(You)' : ''}</div>
                    <div class="player-score">${p.score}</div>
                    <div class="player-time">${p.time}</div>`;
                table.appendChild(row);
            });
        } catch (err) { console.error(err); }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadLeaderboard();
        loadPlayerStats();
     });

    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.classList.remove('show');
        });
    });

    document.getElementById('closeCompletionModal').addEventListener('click', () => {
        document.getElementById('gameCompletionModal').classList.remove('show');
        endGame();
        loadPlayerStats();
    });

    document.getElementById('viewLeaderboardBtn').addEventListener('click', () => {
        document.getElementById('gameCompletionModal').classList.remove('show');
        endGame();
        document.getElementById('leaderboardSection').scrollIntoView({ behavior: 'smooth' });
    });

    document.getElementById('cancelEndGame').addEventListener('click', () => {
        document.getElementById('endGameModal').classList.remove('show');
    });

    document.getElementById('confirmEndGame').addEventListener('click', () => {
        document.getElementById('endGameModal').classList.remove('show');
        endGame();
        showNotification('Game ended');
    });
</script>
{% endblock %}