{% extends "base.html" %}
{% block title %}Find the Word - Dashboard{% endblock %}


{% block content %}
<div class="dashboard-container">

    <!-- Header -->
    <header class="dashboard-header">
        <div class="dashboard-logo">
            <div class="logo-box">F</div>
            <h1 class="dashboard-title">FIND THE WORD</h1>
        </div>
        <div class="header-actions">
            {% if current_user.is_authenticated %}
            <button id="playNowBtn" class="play-now-btn">PLAY NOW</button>
            <div class="user-info">
                <div class="user-avatar">{{ current_user.username[0].upper() }}</div>
                <span class="user-name">{{ current_user.username }}</span>
            </div>
            {% else %}
            <a href="{{ url_for('auth.login') }}" class="play-now-btn">LOGIN TO PLAY</a>
            {% endif %}
        </div>
    </header>

    <!-- Player Stats (Visible before game) -->
    <div id="playerStatsSection" class="player-stats-section">
        <div class="player-stats-card horizontal">
            <div class="player-stats-header">
                <div class="player-avatar-large">{{ current_user.username[0].upper() if current_user.is_authenticated else 'P' }}</div>
                <div class="player-info-large">
                    <h3 id="playerUsername">{{ current_user.username if current_user.is_authenticated else 'Guest' }}</h3>
                    <p class="player-rank-badge">Rank #<span id="playerRank">--</span></p>
                </div>
            </div>
            <div class="stats-grid horizontal">
                <div class="stat-box"><div class="stat-box-value" id="totalGames">0</div><div class="stat-box-label">Total Games</div></div>
                <div class="stat-box"><div class="stat-box-value" id="completedGames">0</div><div class="stat-box-label">Completed</div></div>
                <div class="stat-box"><div class="stat-box-value" id="bestScore">0</div><div class="stat-box-label">Best Score</div></div>
                <div class="stat-box"><div class="stat-box-value" id="avgScore">0</div><div class="stat-box-label">Avg Score</div></div>
            </div>
            <div class="completion-rate horizontal">
                <div class="completion-rate-label">
                    <span>Completion Rate</span>
                    <span id="completionRatePercent">0%</span>
                </div>
                <div class="completion-rate-bar">
                    <div class="completion-rate-fill" id="completionRateFill" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Area -->
    <div id="gameArea" class="hidden">
        <div class="game-layout">
            <div class="game-panel">
                <div class="game-controls">
                    <div class="difficulty-selector">
                        <button class="difficulty-btn easy active" data-difficulty="1">Easy</button>
                        <button class="difficulty-btn medium" data-difficulty="2">Medium</button>
                        <button class="difficulty-btn hard" data-difficulty="3">Hard</button>
                    </div>
                    <div class="game-actions">
                        <button class="action-btn primary" id="newGameBtn">New Game</button>
                        <button class="action-btn danger" id="endGameBtn">End Game</button>
                    </div>
                </div>

                <div class="word-grid-container">
                    <div class="word-grid easy" id="wordGrid"></div>
                </div>

                <div class="words-to-find">
                    <h3>Words to Find</h3>
                    <div class="words-list" id="wordsList"></div>
                </div>
            </div>

            <aside class="side-panel">
                <div class="stats-card">
                    <h3>Game Stats</h3>
                    <div class="stat-item"><span class="stat-label">Time</span><span class="stat-value timer" id="timer">00:00</span></div>
                    <div class="stat-item"><span class="stat-label">Score</span><span class="stat-value score" id="score">0</span></div>
                    <div class="stat-item"><span class="stat-label">Found</span><span class="stat-value" id="foundCount">0/0</span></div>
                    <div class="progress-container">
                        <div class="progress-label"><span>Progress</span><span id="progressPercent">0%</span></div>
                        <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width: 0%"></div></div>
                    </div>
                </div>

                <div class="achievements-card">
                    <h3>Word Information</h3>
                    <div id="wordInfoContent">
                        <p style="text-align:center;color:#aaa;padding:2rem 1rem;">Select a word to see details!</p>
                    </div>
                    <button class="hint-btn" id="hintBtn">Use Hint (-50 pts)</button>
                    <span class="hint-count">Hints: <span id="hintCount">3</span></span>
                </div>
            </aside>
        </div>
    </div>

    <!-- Leaderboard -->
    <section class="leaderboard-section" id="leaderboardSection">
        <h2>Leaderboard</h2>
        <div class="leaderboard-table" id="leaderboardTable">
            <!-- Filled by JS -->
        </div>
    </section>
</div>

<!-- Notification -->
<div id="notificationAlert" class="notification-alert"><span id="notificationMessage"></span></div>

{% endblock %}

{% block scripts %}
<script>
let currentGame = null;
let timerInterval = null;
let seconds = 0;
let hintsUsed = 0;

async function apiCall(url, options = {}) {
    const res = await fetch(url, {
        method: options.method || 'GET',
        headers: { 'Content-Type': 'application/json' },
        body: options.body,
        credentials: 'include'
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.message || 'Error');
    return data;
}

function startGame() {
    const level = document.querySelector('.difficulty-btn.active').dataset.difficulty;
    apiCall('/api/game/start', { method: 'POST', body: JSON.stringify({ level_id: parseInt(level) }) })
        .then(game => {
        console.log(game)
            currentGame = game;
            renderGrid(game.grid);
            renderWordList(game.words);
            startTimer();
            updateStats(0, game.words.length);
            hintsUsed = 0;
            document.getElementById('hintCount').textContent = 3;
            document.getElementById('gameArea').classList.remove('hidden');
            document.getElementById('playerStatsSection').style.display = 'none';
        })
        .catch(err => showNotification('Error: ' + err.message));
}

function renderGrid(grid) {
    const container = document.getElementById('wordGrid');
    container.innerHTML = '';
    container.className = `word-grid ${grid.length === 8 ? 'easy' : grid.length === 10 ? 'medium' : 'hard'}`;
    grid.forEach((row, y) => {
        row.forEach((letter, x) => {
            const cell = document.createElement('div');
            cell.className = 'grid-cell';
            cell.textContent = letter;
            cell.dataset.x = x;
            cell.dataset.y = y;
            container.appendChild(cell);
        });
    });
}

function highlightPath(path) {
    path.forEach(([x, y]) => {
        const cell = document.querySelector(`.grid-cell[data-x="${x}"][data-y="${y}"]`);
        if (cell) cell.classList.add('found');
    });
}

function renderWordList(words) {
    const list = document.getElementById('wordsList');
    list.innerHTML = '';
    words.forEach(word => {
        const item = document.createElement('div');
        item.className = 'word-item';
        item.textContent = word;
        item.id = `word-${word}`;
        list.appendChild(item);
    });
}

function markWordFound(word) {
    const el = document.getElementById(`word-${word}`);
    if (el) el.classList.add('found');
}

function updateStats(found, total) {
    document.getElementById('foundCount').textContent = `${found}/${total}`;
    const progress = (found / total) * 100;
    document.getElementById('progressFill').style.width = progress + '%';
    document.getElementById('progressPercent').textContent = Math.round(progress) + '%';
    document.getElementById('score').textContent = (found * 100 - hintsUsed * 50).toLocaleString();
}

function startTimer() {
    seconds = 0;
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(() => {
        seconds++;
        const m = String(Math.floor(seconds / 60)).padStart(2, '0');
        const s = String(seconds % 60).padStart(2, '0');
        document.getElementById('timer').textContent = `${m}:${s}`;
    }, 1000);
}

document.getElementById('hintBtn').onclick = async () => {
    if (!currentGame || hintsUsed >= 3) return showNotification('No hints left!');
    try {
        const hint = await apiCall('/api/game/hint', {
            method: 'POST',
            body: JSON.stringify({ session_id: currentGame.session_id })
        });
        showNotification(`Hint: Starts with "${hint.hint}"`);
        hintsUsed++;
        document.getElementById('hintCount').textContent = 3 - hintsUsed;
        updateStats(currentGame.found_words?.length || 0, currentGame.words.length);
    } catch (err) { showNotification(err.message); }
};

// Drag selection
let selecting = false;
let selected = [];

document.getElementById('wordGrid').addEventListener('mousedown', e => {
    if (!e.target.classList.contains('grid-cell')) return;
    selecting = true;
    selected = [e.target];
    e.target.classList.add('selected');
});
document.getElementById('wordGrid').addEventListener('mousemove', e => {
    if (!selecting || !e.target.classList.contains('grid-cell')) return;
    if (!selected.includes(e.target)) {
        selected.push(e.target);
        e.target.classList.add('selected');
    }
});
document.addEventListener('mouseup', () => {
    if (!selecting) return;
    selecting = false;
    const word = selected.map(c => c.textContent).join('');
    if (word.length < 3) {
        selected.forEach(c => c.classList.remove('selected'));
        selected = [];
        return;
    }
    submitWord(word);
});

async function submitWord(word) {
    try {
        const result = await apiCall('/api/game/validate', {
            method: 'POST',
            body: JSON.stringify({ session_id: currentGame.session_id, word })
        });

        if (result.valid && !result.already_found) {
            selected.forEach(c => c.classList.add('found'));
            highlightPath(result.path);
            markWordFound(word);
            updateStats(result.found_count, result.total_words);
            showNotification(`+100! Found: ${word}`);
            if (result.found_count === result.total_words) {
                setTimeout(() => endGame(true), 1000);
            }
        } else {
            showNotification(result.already_found ? 'Already found!' : 'Not in list!');
        }
    } catch (err) {
        showNotification('Error: ' + err.message);
    } finally {
        selected.forEach(c => c.classList.remove('selected'));
        selected = [];
    }
}

function endGame(won = false) {
    if (timerInterval) clearInterval(timerInterval);
    if (currentGame) {
        apiCall('/api/game/end', {
            method: 'POST',
            body: JSON.stringify({ session_id: currentGame.session_id })
        }).finally(() => {
            currentGame = null;
            document.getElementById('gameArea').classList.add('hidden');
            document.getElementById('playerStatsSection').style.display = 'block';
            loadLeaderboard();
            showNotification(won ? 'You Won!' : 'Game Ended');
        });
    }
}

function showNotification(msg) {
    const el = document.getElementById('notificationMessage');
    el.textContent = msg;
    const alert = document.getElementById('notificationAlert');
    alert.classList.add('show');
    setTimeout(() => alert.classList.remove('show'), 3000);
}

// Button Events
document.getElementById('playNowBtn')?.addEventListener('click', startGame);
document.getElementById('newGameBtn').addEventListener('click', startGame);
document.getElementById('endGameBtn').addEventListener('click', () => confirm('End game?') && endGame());
document.querySelectorAll('.difficulty-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
    });
});

// Load leaderboard on start
async function loadLeaderboard() {
    try {
        const data = await apiCall('/leaderboard');
        const table = document.getElementById('leaderboardTable');
        table.innerHTML = `<div class="leaderboard-row header">
            <div class="rank">Rank</div>
            <div class="player-name">Player</div>
            <div class="player-score">Score</div>
            <div class="player-time">Time</div>
        </div>`;
        data.forEach((p, i) => {
            const row = document.createElement('div');
            row.className = 'leaderboard-row' + (p.is_current ? ' current-player' : '');
            row.innerHTML = `<div class="rank ${i < 3 ? 'top' : ''}">${i + 1}</div>
                <div class="player-name">${p.username} ${p.is_current ? '(You)' : ''}</div>
                <div class="player-score">${p.score}</div>
                <div class="player-time">${p.time}</div>`;
            table.appendChild(row);
        });
    } catch (err) { console.error(err); }
}

document.addEventListener('DOMContentLoaded', loadLeaderboard);
</script>
{% endblock %}