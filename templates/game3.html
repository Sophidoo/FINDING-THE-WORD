<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find the Word - Gaming Dashboard</title>
    <link rel="stylesheet" href="/static/css/global.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Dashboard Header/Navbar -->
        <header class="dashboard-header">
            <div class="navbar-left">
                <div class="dashboard-logo">
                    <div class="logo-box">F</div>
                    <h1 class="dashboard-title">FIND THE WORD</h1>
                </div>
                <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="Toggle menu">‚ò∞</button>
                <nav class="navbar-links" id="navbarLinks">
                    <a href="game3.html" class="nav-link active">Game</a>
                    <a href="leaderboard2.html" class="nav-link">Leaderboard</a>
                    <a href="contact2.html" class="nav-link">Contact Us</a>
                </nav>
            </div>
            <div class="navbar-right" id="navbarRight">
                <button id="playNowBtn" class="play-now-btn">PLAY NOW</button>
                <div class="user-info" id="userInfoBtn">
                    <div class="user-avatar">P</div>
                    <span class="user-name">Player</span>
                </div>
            </div>
        </header>

        <!-- Player Statistics Section (Always Visible) -->
        <div id="playerStatsSection" class="player-stats-section">
            <div class="player-stats-card horizontal">
                <div class="player-stats-header">
                    <div class="player-avatar-large">P</div>
                    <div class="player-info-large">
                        <h3 id="playerUsername">Player</h3>
                        <p class="player-rank-badge">Rank #<span id="playerRank">--</span></p>
                    </div>
                </div>
                
                <div class="stats-grid horizontal">
                    <div class="stat-box">
                        <div class="stat-box-value" id="totalGames">0</div>
                        <div class="stat-box-label">Total Games</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-value" id="completedGames">0</div>
                        <div class="stat-box-label">Completed</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-value" id="bestScore">0</div>
                        <div class="stat-box-label">Best Score</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-value" id="avgScore">0</div>
                        <div class="stat-box-label">Avg Score</div>
                    </div>
                </div>
                
                <div class="completion-rate horizontal">
                    <div class="completion-rate-label">
                        <span>Completion Rate</span>
                        <span id="completionRatePercent">0%</span>
                    </div>
                    <div class="completion-rate-bar">
                        <div class="completion-rate-fill" id="completionRateFill" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Game Area (Hidden by default) -->
        <div id="gameArea" style="display: none;">
            <!-- Main Game Layout -->
            <div class="game-layout">
            <!-- Game Panel -->
            <div class="game-panel">
                <div class="game-controls">
                    <div class="difficulty-selector">
                        <button class="difficulty-btn easy active" data-difficulty="easy">Easy</button>
                        <button class="difficulty-btn medium" data-difficulty="medium">Medium</button>
                        <button class="difficulty-btn hard" data-difficulty="hard">Hard</button>
                    </div>
                    <div class="game-actions">
                        <button class="action-btn primary" id="newGameBtn">New Game</button>
                        <button class="action-btn" id="resetBtn">Reset</button>
                        <button class="action-btn danger" id="endGameBtn">End Game</button>
                    </div>
                </div>

                <!-- Word Grid -->
                <div class="word-grid-container">
                    <div class="word-grid easy" id="wordGrid">
                        <!-- Grid cells will be generated by JavaScript -->
                    </div>
                </div>

                <!-- Words to Find -->
                <div class="words-to-find">
                    <h3>Words to Find</h3>
                    <div class="words-list" id="wordsList">
                        <!-- Words will be generated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Side Panel -->
            <aside class="side-panel">
                <!-- Stats Card -->
                <div class="stats-card">
                    <h3>Game Stats</h3>
                    <div class="stat-item">
                        <span class="stat-label">Time</span>
                        <span class="stat-value timer" id="timer">03:00</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Score</span>
                        <span class="stat-value score" id="score">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Found</span>
                        <span class="stat-value" id="foundCount">0/5</span>
                    </div>
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Progress</span>
                            <span id="progressPercent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Word Information Card -->
                <div class="achievements-card">
                    <h3>Word Information</h3>
                    <div id="wordInfoContent">
                        <p style="text-align: center; color: #666; font-size: 0.9rem; padding: 2rem 1rem;">
                            Find words to see their definitions, examples, and trivia!
                        </p>
                    </div>
                    <button class="hint-btn" id="hintBtn">Use Hint</button>
                    <span class="hint-count" id="hintCount">Hints: 3</span>
                </div>
            </aside>
        </div>
    </div>

    <!-- Achievements Section (Always Visible) -->
    <section class="dashboard-achievements-section">
        <div class="achievements-header">
            <h2>üèÜ ACHIEVEMENTS</h2>
            <button class="view-leaderboard-btn" onclick="window.location.href='leaderboard.html'">VIEW LEADERBOARD</button>
        </div>
        <div class="dashboard-achievements-grid" id="dashboardAchievementsGrid">
            <!-- Achievements will be dynamically generated by JavaScript -->
        </div>
    </section>
</div>

    <!-- Achievement Unlock Notification -->
    <div id="achievementNotification" class="achievement-notification">
        <div class="achievement-notification-content">
            <div class="achievement-notification-icon" id="achievementNotificationIcon">üèÜ</div>
            <div class="achievement-notification-text">
                <div class="achievement-notification-title">ACHIEVEMENT UNLOCKED!</div>
                <div class="achievement-notification-name" id="achievementNotificationName">Achievement Name</div>
            </div>
        </div>
    </div>

    <!-- Game Completion Modal -->
    <div id="gameCompletionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">üéâ CONGRATULATIONS! üéâ</h2>
            </div>
            <div class="modal-body">
                <p id="modalMessage" class="modal-message"></p>
                <div class="stats-display">
                    <div class="stat-row">
                        <span class="stat-label">üèÜ Score:</span>
                        <span class="stat-value" id="modalScore">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">üìù Total Words:</span>
                        <span class="stat-value" id="modalTotalWords">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">‚úì Words Found:</span>
                        <span class="stat-value" id="modalFoundWords">0</span>
                    </div>
                    <div class="stat-row" id="missedWordsRow">
                        <span class="stat-label">‚ùå Words Missed:</span>
                        <span class="stat-value" id="modalMissedWords">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">üìà Completion Rate:</span>
                        <span class="stat-value" id="modalCompletionRate">0%</span>
                    </div>
                    <div class="stat-row" id="timeRow">
                        <span class="stat-label">‚è±Ô∏è Time Remaining:</span>
                        <span class="stat-value" id="modalTime">00:00</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn" id="viewLeaderboardBtn">View Leaderboard</button>
                <button class="modal-btn" id="closeCompletionModal">Close</button>
            </div>
        </div>
    </div>

    <!-- End Game Confirmation Modal -->
    <div id="endGameModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ö†Ô∏è End Game</h2>
            </div>
            <div class="modal-body">
                <p class="modal-message">Are you sure you want to end the game?</p>
                <p class="modal-submessage">Your progress will be lost.</p>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" id="cancelEndGame">No, Keep Playing</button>
                <button class="modal-btn danger" id="confirmEndGame">Yes, End Game</button>
            </div>
        </div>
    </div>

    <!-- Notification Alert -->
    <div id="notificationAlert" class="notification-alert">
        <span id="notificationMessage"></span>
    </div>

    <script>
        // Game State
        let gameState = {
            difficulty: 'easy',
            gridSize: 8,
            words: [],
            foundWords: [],
            attemptedWords: [], // Array to save all word selections
            selectedCells: [],
            score: 0,
            timeLeft: 180,
            timerInterval: null,
            hintsRemaining: 3,
            isSelecting: false,
            isGameActive: false // Track if game is currently active
        };

        // Player Statistics (persisted in localStorage)
        let playerStats = {
            username: 'Player',
            totalGames: 0,
            completedGames: 0,
            bestScore: 0,
            totalScore: 0,
            scores: [], // Array of all scores
            // Achievement tracking
            achievements: {},
            easyCompleted: 0,
            mediumCompleted: 0,
            hardCompleted: 0,
            perfectGames: 0,
            maxStreak: 0,
            currentStreak: 0
        };

        // Load player stats from localStorage
        function loadPlayerStats() {
            const saved = localStorage.getItem('findTheWordStats');
            if (saved) {
                playerStats = JSON.parse(saved);
                // Ensure new properties exist
                if (!playerStats.achievements) playerStats.achievements = {};
                if (!playerStats.easyCompleted) playerStats.easyCompleted = 0;
                if (!playerStats.mediumCompleted) playerStats.mediumCompleted = 0;
                if (!playerStats.hardCompleted) playerStats.hardCompleted = 0;
                if (!playerStats.perfectGames) playerStats.perfectGames = 0;
                if (!playerStats.maxStreak) playerStats.maxStreak = 0;
                if (!playerStats.currentStreak) playerStats.currentStreak = 0;
            }
            updatePlayerStatsDisplay();
        }

        // Save player stats to localStorage
        function savePlayerStats() {
            localStorage.setItem('findTheWordStats', JSON.stringify(playerStats));
        }

        // Update player statistics display
        function updatePlayerStatsDisplay() {
            document.getElementById('playerUsername').textContent = playerStats.username;
            document.getElementById('totalGames').textContent = playerStats.totalGames;
            document.getElementById('completedGames').textContent = playerStats.completedGames;
            document.getElementById('bestScore').textContent = playerStats.bestScore.toLocaleString();
            
            // Calculate average score
            const avgScore = playerStats.totalGames > 0 
                ? Math.round(playerStats.totalScore / playerStats.totalGames) 
                : 0;
            document.getElementById('avgScore').textContent = avgScore.toLocaleString();
            
            // Calculate completion rate
            const completionRate = playerStats.totalGames > 0 
                ? Math.round((playerStats.completedGames / playerStats.totalGames) * 100) 
                : 0;
            document.getElementById('completionRatePercent').textContent = `${completionRate}%`;
            document.getElementById('completionRateFill').style.width = `${completionRate}%`;
            
            // Calculate player rank in leaderboard
            calculatePlayerRank();
        }

        // Calculate player's rank in leaderboard
        function calculatePlayerRank() {
            const leaderboardScores = [2450, 2180, 1920, 1750, 1580]; // Mock leaderboard scores
            const playerBestScore = playerStats.bestScore;
            
            let rank = 1;
            for (let score of leaderboardScores) {
                if (playerBestScore < score) {
                    rank++;
                } else {
                    break;
                }
            }
            
            document.getElementById('playerRank').textContent = rank;
        }

        // Word lists for different difficulties
        const wordLists = {
            easy: ['CAT', 'DOG', 'FISH', 'BIRD', 'FROG'],
            medium: ['TIGER', 'EAGLE', 'SHARK', 'SNAKE', 'WHALE'],
            hard: ['ELEPHANT', 'DOLPHIN', 'GIRAFFE', 'PENGUIN', 'CHEETAH']
        };

        // Word information database
        const wordInfo = {
            'CAT': {
                definition: 'A small domesticated carnivorous mammal with soft fur, a short snout, and retractable claws.',
                example: 'The cat purred contentedly as it sat on my lap.',
                trivia: 'Cats spend 70% of their lives sleeping, which means a 9-year-old cat has been awake for only three years of its life!'
            },
            'DOG': {
                definition: 'A domesticated carnivorous mammal that typically has a long snout, an acute sense of smell, and a barking voice.',
                example: 'The dog wagged its tail excitedly when its owner came home.',
                trivia: 'Dogs have a sense of time and can tell how long you\'ve been gone based on the amount of scent you\'ve left behind.'
            },
            'FISH': {
                definition: 'A limbless cold-blooded vertebrate animal with gills and fins living wholly in water.',
                example: 'We watched the colorful fish swimming in the coral reef.',
                trivia: 'Some fish can recognize their owner\'s face and even learn to do tricks, just like dogs!'
            },
            'BIRD': {
                definition: 'A warm-blooded egg-laying vertebrate animal with feathers, wings, and a beak.',
                example: 'The bird built its nest in the tree outside our window.',
                trivia: 'The smallest bird in the world is the bee hummingbird, which is only 2 inches long and weighs less than a penny!'
            },
            'FROG': {
                definition: 'A tailless amphibian with a short squat body, moist smooth skin, and very long hind legs for leaping.',
                example: 'The frog jumped from lily pad to lily pad across the pond.',
                trivia: 'Frogs don\'t drink water - they absorb it through their skin! They also use their eyes to help swallow food.'
            },
            'TIGER': {
                definition: 'A very large solitary cat with a yellow-brown coat striped with black, native to the forests of Asia.',
                example: 'The tiger stalked silently through the jungle undergrowth.',
                trivia: 'Each tiger\'s stripe pattern is unique, like human fingerprints. No two tigers have the same stripes!'
            },
            'EAGLE': {
                definition: 'A large bird of prey with a massive hooked bill and long broad wings, known for its keen sight and powerful soaring flight.',
                example: 'The eagle soared high above the mountains, scanning for prey.',
                trivia: 'Eagles can see up to 8 times farther than humans and can spot a rabbit from 2 miles away!'
            },
            'SHARK': {
                definition: 'A long-bodied chiefly marine fish with a cartilaginous skeleton, a prominent dorsal fin, and tooth-like scales.',
                example: 'The shark glided effortlessly through the deep blue ocean.',
                trivia: 'Sharks have been around for more than 400 million years, predating dinosaurs by 200 million years!'
            },
            'SNAKE': {
                definition: 'A long limbless reptile with a scaly body and a fork-shaped tongue, some species of which are venomous.',
                example: 'The snake slithered quietly through the grass.',
                trivia: 'Snakes can\'t blink! They don\'t have eyelids, so they sleep with their eyes open.'
            },
            'WHALE': {
                definition: 'A very large marine mammal with a streamlined hairless body, a horizontal tail fin, and a blowhole on top of the head.',
                example: 'The whale breached the surface, creating a spectacular splash.',
                trivia: 'The blue whale is the largest animal ever known to have lived on Earth, even bigger than the largest dinosaurs!'
            },
            'ELEPHANT': {
                definition: 'A very large plant-eating mammal with a prehensile trunk, long curved ivory tusks, and large ears.',
                example: 'The elephant used its trunk to spray water over its back.',
                trivia: 'Elephants are the only mammals that can\'t jump, but they can recognize themselves in a mirror, showing self-awareness!'
            },
            'DOLPHIN': {
                definition: 'A small gregarious toothed whale that typically has a beaklike snout and a curved fin on the back.',
                example: 'The dolphin leaped gracefully out of the water, performing acrobatic flips.',
                trivia: 'Dolphins have names for each other! They use unique whistles to identify and call specific individuals.'
            },
            'GIRAFFE': {
                definition: 'A large African mammal with a very long neck and forelegs, having a coat patterned with brown patches.',
                example: 'The giraffe stretched its long neck to reach the leaves at the top of the tree.',
                trivia: 'Despite their long necks, giraffes have the same number of neck bones as humans - just seven!'
            },
            'PENGUIN': {
                definition: 'A large flightless seabird of the southern hemisphere, with black upper parts and white underparts.',
                example: 'The penguin waddled across the ice before diving into the frigid water.',
                trivia: 'Penguins can drink seawater because they have a special gland that filters out the salt!'
            },
            'CHEETAH': {
                definition: 'A large slender spotted cat found in Africa and parts of Asia, the fastest land animal.',
                example: 'The cheetah accelerated to incredible speeds while chasing its prey.',
                trivia: 'Cheetahs can go from 0 to 60 mph in just 3 seconds, faster than most sports cars!'
            }
        };

        // Initialize game
        function initGame() {
            const difficulty = gameState.difficulty;
            gameState.gridSize = difficulty === 'easy' ? 8 : difficulty === 'medium' ? 10 : 12;
            gameState.words = [...wordLists[difficulty]];
            gameState.foundWords = [];
            gameState.attemptedWords = []; // Reset attempted words array
            gameState.selectedCells = [];
            gameState.score = 0;
            gameState.timeLeft = difficulty === 'easy' ? 180 : difficulty === 'medium' ? 240 : 300;
            gameState.hintsRemaining = 3;
            gameState.isGameActive = true; // Mark game as active
            
            generateGrid();
            displayWords();
            updateStats();
            startTimer();
            resetWordInfo();
            
            // Increment total games
            playerStats.totalGames++;
            savePlayerStats();
            updatePlayerStatsDisplay();
            
            console.log('Game initialized. Attempted words array reset.');
        }

        // Reset word information panel
        function resetWordInfo() {
            const wordInfoContent = document.getElementById('wordInfoContent');
            wordInfoContent.innerHTML = `
                <p style="text-align: center; color: #666; font-size: 0.9rem; padding: 2rem 1rem;">
                    Find words to see their definitions, examples, and trivia!
                </p>
            `;
        }

        // Display word information
        function displayWordInfo(word) {
            const info = wordInfo[word];
            if (!info) return;
            
            const wordInfoContent = document.getElementById('wordInfoContent');
            
            // Remove the placeholder text if it exists
            const placeholder = wordInfoContent.querySelector('p[style*="text-align: center"]');
            if (placeholder) {
                wordInfoContent.innerHTML = '';
            }
            
            // Create new word info item
            const wordInfoItem = document.createElement('div');
            wordInfoItem.className = 'word-info-item';
            wordInfoItem.innerHTML = `
                <div class="word-info-title">üìñ ${word}</div>
                <div class="word-info-section">
                    <strong>Definition:</strong>
                    <p>${info.definition}</p>
                </div>
                <div class="word-info-section">
                    <strong>Example:</strong>
                    <p><em>"${info.example}"</em></p>
                </div>
                <div class="word-info-section">
                    <strong>üí° Trivia:</strong>
                    <p>${info.trivia}</p>
                </div>
            `;
            
            // Append to the beginning (newest first)
            wordInfoContent.insertBefore(wordInfoItem, wordInfoContent.firstChild);
        }

        // Generate grid
        function generateGrid() {
            const grid = document.getElementById('wordGrid');
            grid.innerHTML = '';
            grid.className = `word-grid ${gameState.difficulty}`;
            
            const totalCells = gameState.gridSize * gameState.gridSize;
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            
            for (let i = 0; i < totalCells; i++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                cell.textContent = letters[Math.floor(Math.random() * letters.length)];
                cell.dataset.index = i;
                
                // Mouse events for drag selection
                cell.addEventListener('mousedown', startSelection);
                cell.addEventListener('mouseenter', continueSelection);
                cell.addEventListener('mouseup', endSelection);
                
                // Touch events for mobile
                cell.addEventListener('touchstart', handleTouchStart);
                cell.addEventListener('touchmove', handleTouchMove);
                cell.addEventListener('touchend', handleTouchEnd);
                
                grid.appendChild(cell);
            }

            // Place words in grid (simplified - just for demonstration)
            placeWordsInGrid();
        }

        // Place words in grid
        function placeWordsInGrid() {
            const grid = document.getElementById('wordGrid');
            const cells = grid.querySelectorAll('.grid-cell');
            const gridData = Array(gameState.gridSize).fill(null).map(() => Array(gameState.gridSize).fill(''));
            
            // Directions: horizontal, vertical, diagonal-down-right, diagonal-down-left
            const directions = [
                { dx: 1, dy: 0, name: 'horizontal' },      // ‚Üí
                { dx: 0, dy: 1, name: 'vertical' },        // ‚Üì
                { dx: 1, dy: 1, name: 'diagonal-right' },  // ‚Üò
                { dx: -1, dy: 1, name: 'diagonal-left' }   // ‚Üô
            ];
            
            // Try to place each word
            gameState.words.forEach(word => {
                let placed = false;
                let attempts = 0;
                const maxAttempts = 100;
                
                while (!placed && attempts < maxAttempts) {
                    // Random position and direction
                    const direction = directions[Math.floor(Math.random() * directions.length)];
                    const row = Math.floor(Math.random() * gameState.gridSize);
                    const col = Math.floor(Math.random() * gameState.gridSize);
                    
                    // Check if word fits
                    if (canPlaceWord(gridData, word, row, col, direction)) {
                        placeWord(gridData, word, row, col, direction);
                        placed = true;
                    }
                    attempts++;
                }
            });
            
            // Fill empty cells with random letters
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            for (let row = 0; row < gameState.gridSize; row++) {
                for (let col = 0; col < gameState.gridSize; col++) {
                    const cellIndex = row * gameState.gridSize + col;
                    if (gridData[row][col] === '') {
                        cells[cellIndex].textContent = letters[Math.floor(Math.random() * letters.length)];
                    } else {
                        cells[cellIndex].textContent = gridData[row][col];
                    }
                }
            }
        }
        
        // Check if word can be placed
        function canPlaceWord(gridData, word, row, col, direction) {
            for (let i = 0; i < word.length; i++) {
                const newRow = row + (i * direction.dy);
                const newCol = col + (i * direction.dx);
                
                // Out of bounds
                if (newRow < 0 || newRow >= gameState.gridSize || 
                    newCol < 0 || newCol >= gameState.gridSize) {
                    return false;
                }
                
                // Cell occupied by different letter
                if (gridData[newRow][newCol] !== '' && gridData[newRow][newCol] !== word[i]) {
                    return false;
                }
            }
            return true;
        }
        
        // Place word in grid
        function placeWord(gridData, word, row, col, direction) {
            for (let i = 0; i < word.length; i++) {
                const newRow = row + (i * direction.dy);
                const newCol = col + (i * direction.dx);
                gridData[newRow][newCol] = word[i];
                
                // Mark cell with word data
                const cellIndex = newRow * gameState.gridSize + newCol;
                const cells = document.querySelectorAll('.grid-cell');
                if (cells[cellIndex]) {
                    cells[cellIndex].dataset.word = word;
                    cells[cellIndex].dataset.direction = direction.name;
                }
            }
        }

        // Selection handlers
        function startSelection(e) {
            e.preventDefault();
            gameState.isSelecting = true;
            gameState.selectedCells = [];
            selectCell(e.target);
        }

        function continueSelection(e) {
            if (gameState.isSelecting) {
                selectCell(e.target);
            }
        }

        function endSelection(e) {
            if (gameState.isSelecting) {
                gameState.isSelecting = false;
                checkWord();
            }
        }

        // Touch handlers
        function handleTouchStart(e) {
            e.preventDefault();
            gameState.isSelecting = true;
            gameState.selectedCells = [];
            selectCell(e.target);
        }

        function handleTouchMove(e) {
            e.preventDefault();
            if (gameState.isSelecting) {
                const touch = e.touches[0];
                const element = document.elementFromPoint(touch.clientX, touch.clientY);
                if (element && element.classList.contains('grid-cell')) {
                    selectCell(element);
                }
            }
        }

        function handleTouchEnd(e) {
            e.preventDefault();
            if (gameState.isSelecting) {
                gameState.isSelecting = false;
                checkWord();
            }
        }

        // Select cell with directional constraints and backtracking support
        function selectCell(cell) {
            if (!cell.classList.contains('grid-cell') || cell.classList.contains('found')) {
                return;
            }
            
            // If this is the first cell, just select it
            if (gameState.selectedCells.length === 0) {
                gameState.selectedCells.push(cell);
                cell.classList.add('selected');
                return;
            }
            
            // Check if this cell is already selected (backtracking)
            const cellIndex = gameState.selectedCells.indexOf(cell);
            if (cellIndex !== -1) {
                // User is backtracking - remove all cells after this one
                const cellsToRemove = gameState.selectedCells.slice(cellIndex + 1);
                cellsToRemove.forEach(c => c.classList.remove('selected'));
                gameState.selectedCells = gameState.selectedCells.slice(0, cellIndex + 1);
                return;
            }
            
            const lastCell = gameState.selectedCells[gameState.selectedCells.length - 1];
            const lastIndex = parseInt(lastCell.dataset.index);
            const currentIndex = parseInt(cell.dataset.index);
            
            const lastRow = Math.floor(lastIndex / gameState.gridSize);
            const lastCol = lastIndex % gameState.gridSize;
            const currentRow = Math.floor(currentIndex / gameState.gridSize);
            const currentCol = currentIndex % gameState.gridSize;
            
            const rowDiff = Math.abs(currentRow - lastRow);
            const colDiff = Math.abs(currentCol - lastCol);
            
            // Allow adjacent cells (horizontal, vertical, or diagonal)
            const isAdjacent = rowDiff <= 1 && colDiff <= 1 && (rowDiff + colDiff > 0);
            
            // Check if continues in same direction
            if (gameState.selectedCells.length >= 2) {
                const prevCell = gameState.selectedCells[gameState.selectedCells.length - 2];
                const prevIndex = parseInt(prevCell.dataset.index);
                const prevRow = Math.floor(prevIndex / gameState.gridSize);
                const prevCol = prevIndex % gameState.gridSize;
                
                const dirRow = lastRow - prevRow;
                const dirCol = lastCol - prevCol;
                const newDirRow = currentRow - lastRow;
                const newDirCol = currentCol - lastCol;
                
                // Must continue in same direction
                if (dirRow !== newDirRow || dirCol !== newDirCol) {
                    return;
                }
            }
            
            if (isAdjacent) {
                gameState.selectedCells.push(cell);
                cell.classList.add('selected');
            }
        }

        // Check if selected cells form a word
        function checkWord() {
            const selectedWord = gameState.selectedCells.map(cell => cell.textContent).join('');
            
            // Only save if user selected at least 2 letters
            if (selectedWord.length >= 2) {
                // Save the attempted word with timestamp and result
                const attempt = {
                    word: selectedWord,
                    timestamp: new Date().toLocaleTimeString(),
                    isCorrect: gameState.words.includes(selectedWord) && !gameState.foundWords.includes(selectedWord),
                    wasAlreadyFound: gameState.foundWords.includes(selectedWord)
                };
                
                gameState.attemptedWords.push(attempt);
                
                // Log to console for debugging
                console.log('Word attempted:', selectedWord);
                console.log('All attempts:', gameState.attemptedWords);
            }
            
            if (gameState.words.includes(selectedWord) && !gameState.foundWords.includes(selectedWord)) {
                // Word found!
                gameState.foundWords.push(selectedWord);
                gameState.selectedCells.forEach(cell => {
                    cell.classList.remove('selected');
                    cell.classList.add('found');
                });
                
                // Update score
                gameState.score += selectedWord.length * 100;
                
                // Update UI
                updateStats();
                markWordAsFound(selectedWord);
                
                // Display word information
                displayWordInfo(selectedWord);
                
                console.log('‚úÖ Correct word found!');
                
                // Check if game is won
                if (gameState.foundWords.length === gameState.words.length) {
                    gameWon();
                }
            } else {
                // Clear selection
                gameState.selectedCells.forEach(cell => {
                    cell.classList.remove('selected');
                });
                
                if (selectedWord.length >= 2) {
                    console.log('‚ùå Incorrect word or already found');
                }
            }
            
            gameState.selectedCells = [];
        }

        // Display words to find
        function displayWords() {
            const wordsList = document.getElementById('wordsList');
            wordsList.innerHTML = '';
            
            gameState.words.forEach(word => {
                const wordItem = document.createElement('div');
                wordItem.className = 'word-item';
                wordItem.textContent = word;
                wordItem.dataset.word = word;
                wordsList.appendChild(wordItem);
            });
        }

        // Mark word as found
        function markWordAsFound(word) {
            const wordItems = document.querySelectorAll('.word-item');
            wordItems.forEach(item => {
                if (item.dataset.word === word) {
                    item.classList.add('found');
                }
            });
        }

        // Update stats
        function updateStats() {
            document.getElementById('score').textContent = gameState.score.toLocaleString();
            document.getElementById('foundCount').textContent = `${gameState.foundWords.length}/${gameState.words.length}`;
            
            const progress = (gameState.foundWords.length / gameState.words.length) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
            document.getElementById('progressPercent').textContent = `${Math.round(progress)}%`;
            
            document.getElementById('hintCount').textContent = `Hints: ${gameState.hintsRemaining}`;
        }

        // Timer
        function startTimer() {
            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
            }
            
            gameState.timerInterval = setInterval(() => {
                gameState.timeLeft--;
                
                const minutes = Math.floor(gameState.timeLeft / 60);
                const seconds = gameState.timeLeft % 60;
                document.getElementById('timer').textContent = 
                    `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                
                if (gameState.timeLeft <= 0) {
                    gameOver();
                }
            }, 1000);
        }

        // Modal Functions
        function showCompletionModal(isWin) {
            const modal = document.getElementById('gameCompletionModal');
            const title = document.getElementById('modalTitle');
            const message = document.getElementById('modalMessage');
            const missedWordsRow = document.getElementById('missedWordsRow');
            const timeRow = document.getElementById('timeRow');
            
            // Calculate stats
            const completionRate = Math.round((gameState.foundWords.length / gameState.words.length) * 100);
            const missedWords = gameState.words.length - gameState.foundWords.length;
            
            // Update modal content
            if (isWin) {
                title.textContent = 'üéâ CONGRATULATIONS! üéâ';
                message.textContent = '‚úÖ All Words Found!';
                missedWordsRow.style.display = 'none';
                timeRow.style.display = 'flex';
            } else {
                title.textContent = '‚è∞ TIME\'S UP! ‚è∞';
                message.textContent = 'Game Over';
                missedWordsRow.style.display = 'flex';
                timeRow.style.display = 'none';
                document.getElementById('modalMissedWords').textContent = missedWords;
            }
            
            // Update stats
            document.getElementById('modalScore').textContent = gameState.score.toLocaleString();
            document.getElementById('modalTotalWords').textContent = gameState.words.length;
            document.getElementById('modalFoundWords').textContent = gameState.foundWords.length;
            document.getElementById('modalCompletionRate').textContent = completionRate + '%';
            document.getElementById('modalTime').textContent = formatTime(gameState.timeLeft);
            
            // Show modal
            modal.classList.add('show');
        }
        
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('show');
        }
        
        // Notification function
        function showNotification(message) {
            const notification = document.getElementById('notificationAlert');
            const messageElement = document.getElementById('notificationMessage');
            
            messageElement.textContent = message;
            notification.classList.add('show');
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }
        
        function showEndGameModal() {
            // Only show if game is active
            if (!gameState.isGameActive) {
                showNotification('‚ö†Ô∏è Game already ended! Please start a new game.');
                return;
            }
            const modal = document.getElementById('endGameModal');
            modal.classList.add('show');
        }

        // Show game completion modal
        function showCompletionModal(won) {
            const modal = document.getElementById('gameCompletionModal');
            const title = document.getElementById('modalTitle');
            const message = document.getElementById('modalMessage');
            const scoreEl = document.getElementById('modalScore');
            const totalWordsEl = document.getElementById('modalTotalWords');
            const foundWordsEl = document.getElementById('modalFoundWords');
            const missedWordsEl = document.getElementById('modalMissedWords');
            const missedWordsRow = document.getElementById('missedWordsRow');
            const completionRateEl = document.getElementById('modalCompletionRate');
            const timeEl = document.getElementById('modalTime');
            const timeRow = document.getElementById('timeRow');
            
            // Set title and message based on win/lose
            if (won) {
                title.textContent = 'üéâ CONGRATULATIONS! üéâ';
                message.textContent = 'You found all the words!';
                missedWordsRow.style.display = 'none';
                timeRow.style.display = 'flex';
                timeEl.textContent = document.getElementById('timer').textContent;
            } else {
                title.textContent = '‚è∞ TIME\'S UP! ‚è∞';
                message.textContent = 'Better luck next time!';
                missedWordsRow.style.display = 'flex';
                const missedCount = gameState.words.length - gameState.foundWords.length;
                missedWordsEl.textContent = missedCount;
                timeRow.style.display = 'none';
            }
            
            // Set statistics
            scoreEl.textContent = gameState.score.toLocaleString();
            totalWordsEl.textContent = gameState.words.length;
            foundWordsEl.textContent = gameState.foundWords.length;
            
            const completionRate = Math.round((gameState.foundWords.length / gameState.words.length) * 100);
            completionRateEl.textContent = completionRate + '%';
            
            // Show modal
            modal.classList.add('show');
        }

        // Close game completion modal
        function closeCompletionModal() {
            const modal = document.getElementById('gameCompletionModal');
            modal.classList.remove('show');
        }

        // Game won
        function gameWon() {
            clearInterval(gameState.timerInterval);
            gameState.isGameActive = false; // Mark game as inactive
            
            // Save previous stats before updating
            const previousStats = JSON.parse(JSON.stringify(playerStats));
            
            // Update player statistics
            playerStats.completedGames++;
            playerStats.totalScore += gameState.score;
            playerStats.scores.push(gameState.score);
            
            if (gameState.score > playerStats.bestScore) {
                playerStats.bestScore = gameState.score;
            }
            
            // Track difficulty completions
            const difficultyKey = `${gameState.difficulty}Completed`;
            playerStats[difficultyKey] = (playerStats[difficultyKey] || 0) + 1;
            
            // Track perfect games (all words found)
            if (gameState.foundWords.length === gameState.words.length) {
                playerStats.perfectGames = (playerStats.perfectGames || 0) + 1;
            }
            
            // Track streak (consecutive word finds)
            playerStats.currentStreak = (playerStats.currentStreak || 0) + 1;
            if (playerStats.currentStreak > (playerStats.maxStreak || 0)) {
                playerStats.maxStreak = playerStats.currentStreak;
            }
            
            savePlayerStats();
            updatePlayerStatsDisplay();
            
            // Check for newly unlocked achievements and show notifications
            try {
                if (typeof notifyNewAchievements === 'function') {
                    notifyNewAchievements(previousStats);
                }
            } catch (e) {
                console.log('Achievement notification error:', e);
            }
            
            // Re-render achievements to show updated progress
            try {
                if (typeof renderDashboardAchievements === 'function') {
                    renderDashboardAchievements();
                }
            } catch (e) {
                console.log('Achievement render error:', e);
            }
            
            // Show player stats section again
            document.getElementById('playerStatsSection').style.display = 'block';
            
            // Show completion modal
            showCompletionModal(true);
        }

        // Game over
        function gameOver() {
            clearInterval(gameState.timerInterval);
            gameState.isGameActive = false; // Mark game as inactive
            
            // Save previous stats before updating
            const previousStats = JSON.parse(JSON.stringify(playerStats));
            
            // Update player statistics (partial completion)
            playerStats.totalScore += gameState.score;
            playerStats.scores.push(gameState.score);
            
            if (gameState.score > playerStats.bestScore) {
                playerStats.bestScore = gameState.score;
            }
            
            // Reset streak on incomplete game
            playerStats.currentStreak = 0;
            
            savePlayerStats();
            updatePlayerStatsDisplay();
            
            // Check for newly unlocked achievements (e.g., high score)
            try {
                if (typeof notifyNewAchievements === 'function') {
                    notifyNewAchievements(previousStats);
                }
            } catch (e) {
                console.log('Achievement notification error:', e);
            }
            
            // Re-render achievements
            try {
                if (typeof renderDashboardAchievements === 'function') {
                    renderDashboardAchievements();
                }
            } catch (e) {
                console.log('Achievement render error:', e);
            }
            
            // Show player stats section again
            document.getElementById('playerStatsSection').style.display = 'block';
            
            console.log('Game Over! Final attempts:', gameState.attemptedWords);
            
            // Show completion modal
            showCompletionModal(false);
        }
        
        // End game function
        function endGame() {
            clearInterval(gameState.timerInterval);
            gameState.isGameActive = false; // Mark game as inactive
            
            // Update player statistics (partial completion)
            playerStats.totalScore += gameState.score;
            playerStats.scores.push(gameState.score);
            
            if (gameState.score > playerStats.bestScore) {
                playerStats.bestScore = gameState.score;
            }
            
            // Reset streak on manual end
            playerStats.currentStreak = 0;
            
            savePlayerStats();
            updatePlayerStatsDisplay();
            
            // Show player stats section again
            document.getElementById('playerStatsSection').style.display = 'block';
            
            // Show completion modal
            showCompletionModal(false);
        }

        // Format time
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        // Hint system
        document.getElementById('hintBtn').addEventListener('click', () => {
            if (gameState.hintsRemaining <= 0) {
                alert('No hints remaining!');
                return;
            }
            
            // Find a word that hasn't been found yet
            const remainingWords = gameState.words.filter(word => !gameState.foundWords.includes(word));
            if (remainingWords.length === 0) return;
            
            const wordToHint = remainingWords[0];
            const cells = document.querySelectorAll('.grid-cell');
            
            // Highlight first letter of the word
            cells.forEach(cell => {
                if (cell.dataset.word === wordToHint && !cell.classList.contains('found')) {
                    cell.classList.add('hint');
                    setTimeout(() => cell.classList.remove('hint'), 2000);
                }
            });
            
            gameState.hintsRemaining--;
            updateStats();
            
            if (gameState.hintsRemaining === 0) {
                document.getElementById('hintBtn').disabled = true;
            }
        });

        // Difficulty selector
        document.querySelectorAll('.difficulty-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                gameState.difficulty = btn.dataset.difficulty;
                initGame();
            });
        });

        // Achievement Definitions (global scope for access from game functions)
        const achievementDefinitions = [
            { id: 'score_bronze', name: 'Bronze Scorer', description: 'Reach a score of 500', icon: 'ü•â', requirement: { type: 'score', value: 500 }, category: 'score' },
            { id: 'score_silver', name: 'Silver Scorer', description: 'Reach a score of 1000', icon: 'ü•à', requirement: { type: 'score', value: 1000 }, category: 'score' },
            { id: 'score_gold', name: 'Gold Scorer', description: 'Reach a score of 2000', icon: 'ü•á', requirement: { type: 'score', value: 2000 }, category: 'score' },
            { id: 'streak_3', name: 'Word Streak', description: 'Find 3 words in a row', icon: 'üî•', requirement: { type: 'streak', value: 3 }, category: 'streak' },
            { id: 'streak_5', name: 'Hot Streak', description: 'Find 5 words in a row', icon: 'üî•üî•', requirement: { type: 'streak', value: 5 }, category: 'streak' },
            { id: 'streak_10', name: 'Unstoppable', description: 'Find 10 words in a row', icon: 'üî•üî•üî•', requirement: { type: 'streak', value: 10 }, category: 'streak' },
            { id: 'complete_easy', name: 'Easy Master', description: 'Complete 10 Easy games', icon: '‚úÖ', requirement: { type: 'difficulty', difficulty: 'easy', value: 10 }, category: 'completion' },
            { id: 'complete_medium', name: 'Medium Master', description: 'Complete 10 Medium games', icon: '‚úÖ‚úÖ', requirement: { type: 'difficulty', difficulty: 'medium', value: 10 }, category: 'completion' },
            { id: 'complete_hard', name: 'Hard Master', description: 'Complete 10 Hard games', icon: '‚úÖ‚úÖ‚úÖ', requirement: { type: 'difficulty', difficulty: 'hard', value: 10 }, category: 'completion' },
            { id: 'perfect_game', name: 'Perfectionist', description: 'Complete a game with 100% words found', icon: 'üíØ', requirement: { type: 'perfect', value: 1 }, category: 'special' },
            { id: 'games_10', name: 'Getting Started', description: 'Play 10 games', icon: 'üéÆ', requirement: { type: 'games', value: 10 }, category: 'special' },
            { id: 'games_50', name: 'Marathon Player', description: 'Play 50 games', icon: 'üèÉ', requirement: { type: 'games', value: 50 }, category: 'special' }
        ];

        // Check if achievement is unlocked
        function checkAchievementUnlocked(achievement, stats) {
            const req = achievement.requirement;
            switch (req.type) {
                case 'score': return stats.bestScore >= req.value;
                case 'streak': return (stats.maxStreak || 0) >= req.value;
                case 'difficulty': return (stats[`${req.difficulty}Completed`] || 0) >= req.value;
                case 'perfect': return (stats.perfectGames || 0) >= req.value;
                case 'games': return stats.totalGames >= req.value;
                default: return false;
            }
        }

        // Calculate achievement progress percentage
        function calculateProgress(achievement, stats) {
            const req = achievement.requirement;
            let current = 0;
            switch (req.type) {
                case 'score': current = stats.bestScore; break;
                case 'streak': current = stats.maxStreak || 0; break;
                case 'difficulty': current = stats[`${req.difficulty}Completed`] || 0; break;
                case 'perfect': current = stats.perfectGames || 0; break;
                case 'games': current = stats.totalGames; break;
            }
            return Math.min(100, Math.round((current / req.value) * 100));
        }

        // Render achievements on dashboard
        function renderDashboardAchievements() {
            const grid = document.getElementById('dashboardAchievementsGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            achievementDefinitions.forEach(achievement => {
                const unlocked = checkAchievementUnlocked(achievement, playerStats);
                const progress = calculateProgress(achievement, playerStats);
                
                const card = document.createElement('div');
                card.className = `dashboard-achievement-card ${unlocked ? 'unlocked' : 'locked'}`;
                card.innerHTML = `
                    <div class="dashboard-achievement-icon ${unlocked ? '' : 'locked'}">${achievement.icon}</div>
                    <div class="dashboard-achievement-details">
                        <h3 class="dashboard-achievement-title">${achievement.name}</h3>
                        <p class="dashboard-achievement-description">${achievement.description}</p>
                        ${!unlocked ? `
                            <div class="dashboard-achievement-progress">
                                <div class="dashboard-achievement-progress-bar">
                                    <div class="dashboard-achievement-progress-fill" style="width: ${progress}%"></div>
                                </div>
                                <span class="dashboard-achievement-progress-text">${progress}%</span>
                            </div>
                        ` : '<div class="dashboard-achievement-completed">‚úì UNLOCKED</div>'}
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // Show achievement unlock notification
        function showAchievementNotification(achievement) {
            const notification = document.getElementById('achievementNotification');
            const iconElement = document.getElementById('achievementNotificationIcon');
            const nameElement = document.getElementById('achievementNotificationName');
            
            iconElement.textContent = achievement.icon;
            nameElement.textContent = achievement.name;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // Check for newly unlocked achievements
        function checkNewlyUnlockedAchievements(previousStats, currentStats) {
            const newlyUnlocked = [];
            achievementDefinitions.forEach(achievement => {
                const wasUnlocked = checkAchievementUnlocked(achievement, previousStats);
                const isNowUnlocked = checkAchievementUnlocked(achievement, currentStats);
                if (!wasUnlocked && isNowUnlocked) {
                    newlyUnlocked.push(achievement);
                }
            });
            return newlyUnlocked;
        }

        // Show notifications for newly unlocked achievements
        function notifyNewAchievements(previousStats) {
            const newAchievements = checkNewlyUnlockedAchievements(previousStats, playerStats);
            if (newAchievements.length > 0) {
                showAchievementNotification(newAchievements[0]);
                newAchievements.slice(1).forEach((achievement, index) => {
                    setTimeout(() => {
                        showAchievementNotification(achievement);
                    }, (index + 1) * 4500);
                });
            }
        }

        // "Play Now" button functionality
        document.addEventListener('DOMContentLoaded', () => {
            loadPlayerStats();
            
            document.getElementById('playNowBtn').addEventListener('click', () => {
                // Hide the button
                document.getElementById('playNowBtn').style.display = 'none';
                
                // Show the game area
                document.getElementById('gameArea').style.display = 'block';
                
                // Hide player stats section during gameplay
                document.getElementById('playerStatsSection').style.display = 'none';
                
                // Initialize the game
                initGame();
            });

            // New game button
            document.getElementById('newGameBtn').addEventListener('click', () => {
                initGame();
            });

            // Reset button
            document.getElementById('resetBtn').addEventListener('click', () => {
                if (confirm('Are you sure you want to reset the current game?')) {
                    initGame();
                }
            });
            
            // End game button
            document.getElementById('endGameBtn').addEventListener('click', () => {
                showEndGameModal();
            });
            
            // Modal event listeners
            document.getElementById('closeCompletionModal').addEventListener('click', () => {
                closeModal('gameCompletionModal');
            });
            
            document.getElementById('viewLeaderboardBtn').addEventListener('click', () => {
                closeModal('gameCompletionModal');
                // Scroll to leaderboard section
                const leaderboard = document.querySelector('.leaderboard-section');
                leaderboard.scrollIntoView({ behavior: 'smooth', block: 'start' });
            });
            
            document.getElementById('cancelEndGame').addEventListener('click', () => {
                closeModal('endGameModal');
            });
            
            document.getElementById('confirmEndGame').addEventListener('click', () => {
                closeModal('endGameModal');
                endGame();
            });
            
            // Close modal when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    closeModal('gameCompletionModal');
                    closeModal('endGameModal');
                }
            });
            
            // Prevent text selection during drag
            document.addEventListener('selectstart', (e) => {
                if (gameState.isSelecting) {
                    e.preventDefault();
                }
            });

            // Navigate to profile page
            document.getElementById('userInfoBtn').addEventListener('click', () => {
                window.location.href = 'profile.html';
            });

            // Completion modal button handlers
            document.getElementById('closeCompletionModal').addEventListener('click', () => {
                closeCompletionModal();
            });
            
            document.getElementById('viewLeaderboardBtn').addEventListener('click', () => {
                window.location.href = 'leaderboard.html';
            });
            // Initial render of achievements (using global function)
            renderDashboardAchievements();
            
            // Mobile menu toggle
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const navbarLinks = document.getElementById('navbarLinks');
            const navbarRight = document.getElementById('navbarRight');
            
            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener('click', () => {
                    mobileMenuBtn.classList.toggle('active');
                    navbarLinks.classList.toggle('active');
                    navbarRight.classList.toggle('active');
                    
                    // Update button text
                    mobileMenuBtn.textContent = mobileMenuBtn.classList.contains('active') ? '‚úï' : '‚ò∞';
                });
            }
        });
    </script>
</body>
</html>
