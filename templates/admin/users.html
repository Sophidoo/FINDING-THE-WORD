
{% extends "admin/layout.html" %}

{% block title %}Dashboard - Find the Word{% endblock %}

{% block header_title %}üìä Dashboard Users{% endblock %}
{% block header_subtitle %}Welcome back! Here is what's happening.{% endblock %}

{% block content %}
     <!-- Header -->
    <header class="admin-header">
        <div class="admin-header-left">
            <h1>üë• Users Management</h1>
            <p>Manage user accounts and permissions</p>
        </div>
        <div class="admin-header-right">
            <div class="admin-user-badge">
                <div class="admin-avatar">A</div>
                <span class="admin-name">Admin</span>
            </div>
        </div>
    </header>
    
    <!-- Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-card-icon">üë•</div>
            <div class="stat-card-value" id="totalUsers">0</div>
            <div class="stat-card-label">Total Users</div>
        </div>
        <div class="stat-card primary">
            <div class="stat-card-icon">üëë</div>
            <div class="stat-card-value" id="totalAdmins">0</div>
            <div class="stat-card-label">Admins</div>
        </div>
        <div class="stat-card">
            <div class="stat-card-icon">üéÆ</div>
            <div class="stat-card-value" id="totalGamesPlayed">0</div>
            <div class="stat-card-label">Games Played</div>
        </div>
    </div>
    
    <!-- Filter Controls -->
    <div class="filter-controls">
        <div class="filter-group">
            <label>Role:</label>
            <select class="filter-select" id="filterRole" onchange="filterUsers()">
                <option value="">All Roles</option>
                <option value="admin">Admin</option>
                <option value="user">User</option>
            </select>
        </div>
        <div class="filter-group">
            <input type="text" class="search-input" id="searchUser" placeholder="Search users..." oninput="filterUsers()">
        </div>
    </div>
    
    <!-- Users Table -->
    <div class="admin-panel">
        <div class="panel-header">
            <h2>üë§ User Accounts</h2>
            <span id="userCount">0 users</span>
        </div>
        <div class="panel-body">
            <table class="data-table" id="usersTable">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Games Played</th>
                        <th>Best Score</th>
                        <th>Joined</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <!-- Users will be loaded here -->
                </tbody>
            </table>
            
            <div class="empty-state" id="emptyState" style="display: none;">
                <div class="empty-state-icon">üë§</div>
                <h3>No Users Found</h3>
                <p>No users match your filter criteria.</p>
            </div>
        </div>
    </div>
    
    <!-- Role Change Modal -->
    <div class="admin-modal" id="roleModal">
        <div class="admin-modal-content" style="max-width: 400px;">
            <div class="admin-modal-header">
                <h3 id="roleModalTitle">Change Role</h3>
                <button class="modal-close" onclick="closeRoleModal()">&times;</button>
            </div>
            <div class="admin-modal-body">
                <p style="text-align: center; font-size: 1rem;" id="roleModalMessage">
                    Are you sure you want to change this user's role?
                </p>
            </div>
            <div class="admin-modal-footer">
                <button class="btn btn-secondary" onclick="closeRoleModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmRoleChange()">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div class="admin-modal" id="deleteModal">
        <div class="admin-modal-content" style="max-width: 400px;">
            <div class="admin-modal-header">
                <h3>‚ö†Ô∏è Delete User</h3>
                <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
            </div>
            <div class="admin-modal-body">
                <p style="text-align: center; font-size: 1rem;">
                    Are you sure you want to delete "<strong id="deleteUserName"></strong>"?
                </p>
                <p style="text-align: center; color: #666; font-size: 0.9rem;">
                    This action cannot be undone. All user data will be lost.
                </p>
            </div>
            <div class="admin-modal-footer">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Delete User</button>
            </div>
        </div>
    </div>
{% endblock %}
{% block scripts %}
    <script>
        let users = [];
        let currentPage = 1;
        let totalPages = 1;
        let changingRoleUserId = null;
        let changingRoleUserName = ""; // Store name for modal
        let deletingUserId = null;

        async function loadStats() {
            try {
                const res = await fetch('/admin/api/stats');
                const data = await res.json();
                
                if (res.ok) {
                    document.getElementById('totalUsers').textContent = data.users.total;
                    document.getElementById('totalAdmins').textContent = data.users.admins;
                    
                    // Assuming your stats API returns a total game count
                    const totalGames = data.games ? data.games.total : 0;
                    document.getElementById('totalGamesPlayed').textContent = totalGames;
                }
            } catch (err) {
                console.error("Failed to load stats", err);
            }
        }
        
        async function loadUsers() {
            const role = document.getElementById('filterRole').value;
            const search = document.getElementById('searchUser').value.trim();
            
            let url = `/admin/api/users?page=${currentPage}&per_page=10`;
            if (role) url += `&role=${role}`;
            if (search) url += `&search=${encodeURIComponent(search)}`;

            try {
                const res = await fetch(url);
                const data = await res.json();
                
                users = data.users;
                totalPages = data.pages;
                
                // Pagination controls update
                document.getElementById('userCount').textContent = `${data.total} users`;
                // If you have pagination elements with these IDs (recommended to add them if missing)
                // document.getElementById('pageInfo').textContent = `Page ${data.current_page} of ${data.pages}`;
                
                renderUsers(users, data.total);
            } catch (err) {
                console.error("Error loading users:", err);
                Swal.fire('Error', 'Failed to load users', 'error');
            }
        }

        function renderUsers(usersToRender, totalCount) {
            const tbody = document.getElementById('usersTableBody');
            const emptyState = document.getElementById('emptyState');
            
            if (usersToRender.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                document.getElementById('usersTable').style.display = 'none';
                return;
            }
            
            emptyState.style.display = 'none';
            document.getElementById('usersTable').style.display = 'table';
            
            tbody.innerHTML = usersToRender.map(user => `
                <tr>
                    <td><strong>${user.username}</strong></td>
                    <td>${user.email}</td>
                    <td>
                        <span class="badge badge-${user.is_admin ? 'admin' : 'user'}">
                            ${user.is_admin ? 'Admin' : 'User'}
                        </span>
                    </td>
                    <td>${user.games_played}</td>
                    <td>${user.total_score || 0}</td>
                    <td>${user.created_at ? new Date(user.created_at).toLocaleDateString() : '-'}</td>
                    <td>
                        <div class="table-actions">
                            <button class="action-btn" onclick="changeRole(${user.id}, '${user.is_admin ? 'user' : 'admin'}', '${user.username}')" 
                                title="${user.is_admin ? 'Revoke Admin' : 'Make Admin'}">
                                ${user.is_admin ? 'üë§' : 'üëë'}
                            </button>
                            <button class="action-btn delete" onclick="deleteUser(${user.id}, '${user.username}')" title="Delete">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        // Update statistics
        function updateStats() {
            const totalUsers = users.length;
            const totalAdmins = users.filter(u => u.role === 'admin').length;
            const totalGamesPlayed = users.reduce((sum, u) => sum + (u.totalGames || 0), 0);
            
            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('totalAdmins').textContent = totalAdmins;
            document.getElementById('totalGamesPlayed').textContent = totalGamesPlayed;
        }
        
        // Filter users
        function filterUsers() {
            currentPage = 1; // Reset to page 1 on new filter
            loadUsers();
        }
        
        // Change role
        function changeRole(id, newRole, username) {
            changingRoleUserId = id;
            changingRoleUserName = username;
            
            if (newRole === 'admin') {
                document.getElementById('roleModalTitle').textContent = 'üëë Make Admin';
                document.getElementById('roleModalMessage').innerHTML = `
                    Make <strong>${username}</strong> an admin?<br>
                    <small style="color: #666;">They will have access to this admin panel.</small>
                `;
            } else {
                document.getElementById('roleModalTitle').textContent = 'üë§ Remove Admin';
                document.getElementById('roleModalMessage').innerHTML = `
                    Remove admin privileges from <strong>${username}</strong>?<br>
                    <small style="color: #666;">They will no longer have access to this admin panel.</small>
                `;
            }
            document.getElementById('roleModal').classList.add('show');
        }
        
        // Confirm role change
        async function confirmRoleChange() {
            if (!changingRoleUserId) return;

            try {
                // Note: Your route is PUT /api/users/<id>/toggle-admin based on admin_bp.py
                const res = await fetch(`/admin/api/users/${changingRoleUserId}/toggle-admin`, {
                    method: 'PUT', // Changed to PUT to match your blueprint
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();

                if (res.ok) {
                    Swal.fire('Success', data.message, 'success');
                    closeRoleModal();
                    loadUsers();
                    loadStats(); // Update admin count stats
                } else {
                    Swal.fire('Error', data.error || 'Failed to change role', 'error');
                    closeRoleModal();
                }
            } catch (err) {
                Swal.fire('Error', 'API Error', 'error');
            }
        }

        function deleteUser(id, username) {
            deletingUserId = id;
            document.getElementById('deleteUserName').textContent = username;
            document.getElementById('deleteModal').classList.add('show');
        }

        async function confirmDelete() {
            if (!deletingUserId) return;

            try {
                const res = await fetch(`/admin/api/users/${deletingUserId}`, {
                    method: 'DELETE'
                });
                const data = await res.json();

                if (res.ok) {
                    Swal.fire('Deleted!', data.message, 'success');
                    closeDeleteModal();
                    loadUsers();
                    loadStats();
                } else {
                    Swal.fire('Error', data.error || 'Failed to delete user', 'error');
                    closeDeleteModal();
                }
            } catch (err) {
                Swal.fire('Error', 'API Error', 'error');
            }
        }

        // --- MODAL UTILS ---
        function closeRoleModal() {
            document.getElementById('roleModal').classList.remove('show');
            changingRoleUserId = null;
        }
        
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('show');
            deletingUserId = null;
        }
        
        document.querySelectorAll('.admin-modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.classList.remove('show');
            });
        });

        // Helper for capitalization
        function capitalizeFirst(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
        
        // Close modal on outside click
        document.getElementById('roleModal').addEventListener('click', (e) => {
            if (e.target.id === 'roleModal') closeRoleModal();
        });
        
        document.getElementById('deleteModal').addEventListener('click', (e) => {
            if (e.target.id === 'deleteModal') closeDeleteModal();
        });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadUsers();
            // initSidebarToggle(); // If defined in layout, this is fine
        });
    </script>
{% endblock %}