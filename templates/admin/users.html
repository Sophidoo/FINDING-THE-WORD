
{% extends "admin/layout.html" %}

{% block title %}Dashboard - Find the Word{% endblock %}

{% block header_title %}ğŸ“Š Dashboard Users{% endblock %}
{% block header_subtitle %}Welcome back! Here is what's happening.{% endblock %}

{% block content %}
     <!-- Header -->
    <header class="admin-header">
        <div class="admin-header-left">
            <h1>ğŸ‘¥ Users Management</h1>
            <p>Manage user accounts and permissions</p>
        </div>
        <div class="admin-header-right">
            <div class="admin-user-badge">
                <div class="admin-avatar">A</div>
                <span class="admin-name">Admin</span>
            </div>
        </div>
    </header>
    
    <!-- Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-card-icon">ğŸ‘¥</div>
            <div class="stat-card-value" id="totalUsers">0</div>
            <div class="stat-card-label">Total Users</div>
        </div>
        <div class="stat-card primary">
            <div class="stat-card-icon">ğŸ‘‘</div>
            <div class="stat-card-value" id="totalAdmins">0</div>
            <div class="stat-card-label">Admins</div>
        </div>
        <div class="stat-card">
            <div class="stat-card-icon">ğŸ®</div>
            <div class="stat-card-value" id="totalGamesPlayed">0</div>
            <div class="stat-card-label">Games Played</div>
        </div>
    </div>
    
    <!-- Filter Controls -->
    <div class="filter-controls">
        <div class="filter-group">
            <label>Role:</label>
            <select class="filter-select" id="filterRole" onchange="filterUsers()">
                <option value="">All Roles</option>
                <option value="admin">Admin</option>
                <option value="user">User</option>
            </select>
        </div>
        <div class="filter-group">
            <input type="text" class="search-input" id="searchUser" placeholder="Search users..." oninput="filterUsers()">
        </div>
    </div>
    
    <!-- Users Table -->
    <div class="admin-panel">
        <div class="panel-header">
            <h2>ğŸ‘¤ User Accounts</h2>
            <span id="userCount">0 users</span>
        </div>
        <div class="panel-body">
            <table class="data-table" id="usersTable">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Games Played</th>
                        <th>Best Score</th>
                        <th>Joined</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <!-- Users will be loaded here -->
                </tbody>
            </table>
            
            <div class="empty-state" id="emptyState" style="display: none;">
                <div class="empty-state-icon">ğŸ‘¤</div>
                <h3>No Users Found</h3>
                <p>No users match your filter criteria.</p>
            </div>
        </div>
    </div>
    
    <!-- Role Change Modal -->
    <div class="admin-modal" id="roleModal">
        <div class="admin-modal-content" style="max-width: 400px;">
            <div class="admin-modal-header">
                <h3 id="roleModalTitle">Change Role</h3>
                <button class="modal-close" onclick="closeRoleModal()">&times;</button>
            </div>
            <div class="admin-modal-body">
                <p style="text-align: center; font-size: 1rem;" id="roleModalMessage">
                    Are you sure you want to change this user's role?
                </p>
            </div>
            <div class="admin-modal-footer">
                <button class="btn btn-secondary" onclick="closeRoleModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmRoleChange()">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div class="admin-modal" id="deleteModal">
        <div class="admin-modal-content" style="max-width: 400px;">
            <div class="admin-modal-header">
                <h3>âš ï¸ Delete User</h3>
                <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
            </div>
            <div class="admin-modal-body">
                <p style="text-align: center; font-size: 1rem;">
                    Are you sure you want to delete "<strong id="deleteUserName"></strong>"?
                </p>
                <p style="text-align: center; color: #666; font-size: 0.9rem;">
                    This action cannot be undone. All user data will be lost.
                </p>
            </div>
            <div class="admin-modal-footer">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Delete User</button>
            </div>
        </div>
    </div>
{% endblock %}
{% block scripts %}
    <script>
        let users = [];
        let changingRoleUserId = null;
        let newRole = null;
        let deletingUserId = null;
        
        // Load users from localStorage
        function loadUsers() {
            users = JSON.parse(localStorage.getItem('adminUsers')) || [];
            updateStats();
            renderUsers(users);
        }
        
        // Update statistics
        function updateStats() {
            const totalUsers = users.length;
            const totalAdmins = users.filter(u => u.role === 'admin').length;
            const totalGamesPlayed = users.reduce((sum, u) => sum + (u.totalGames || 0), 0);
            
            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('totalAdmins').textContent = totalAdmins;
            document.getElementById('totalGamesPlayed').textContent = totalGamesPlayed;
        }
        
        // Render users to table
        function renderUsers(usersToRender) {
            const tbody = document.getElementById('usersTableBody');
            const emptyState = document.getElementById('emptyState');
            const userCount = document.getElementById('userCount');
            
            userCount.textContent = `${usersToRender.length} users`;
            
            if (usersToRender.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                document.getElementById('usersTable').style.display = 'none';
                return;
            }
            
            emptyState.style.display = 'none';
            document.getElementById('usersTable').style.display = 'table';
            
            tbody.innerHTML = usersToRender.map(user => `
                <tr>
                    <td><strong>${user.username}</strong></td>
                    <td>${user.email}</td>
                    <td>
                        <span class="badge badge-${user.role}">${capitalizeFirst(user.role)}</span>
                    </td>
                    <td>${user.totalGames || 0}</td>
                    <td>${(user.bestScore || 0).toLocaleString()}</td>
                    <td>${user.joinedDate}</td>
                    <td>
                        <div class="table-actions">
                            ${user.role === 'user' 
                                ? `<button class="action-btn" onclick="changeRole(${user.id}, 'admin')" title="Make Admin">ğŸ‘‘</button>`
                                : `<button class="action-btn" onclick="changeRole(${user.id}, 'user')" title="Remove Admin">ğŸ‘¤</button>`
                            }
                            <button class="action-btn delete" onclick="deleteUser(${user.id})" title="Delete">ğŸ—‘ï¸</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        // Filter users
        function filterUsers() {
            const role = document.getElementById('filterRole').value;
            const search = document.getElementById('searchUser').value.toLowerCase();
            
            let filtered = users;
            
            if (role) {
                filtered = filtered.filter(u => u.role === role);
            }
            
            if (search) {
                filtered = filtered.filter(u => 
                    u.username.toLowerCase().includes(search) || 
                    u.email.toLowerCase().includes(search)
                );
            }
            
            renderUsers(filtered);
        }
        
        // Change role
        function changeRole(userId, role) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            changingRoleUserId = userId;
            newRole = role;
            
            if (role === 'admin') {
                document.getElementById('roleModalTitle').textContent = 'ğŸ‘‘ Make Admin';
                document.getElementById('roleModalMessage').innerHTML = `
                    Make <strong>${user.username}</strong> an admin?<br>
                    <small style="color: #666;">They will have access to this admin panel.</small>
                `;
            } else {
                document.getElementById('roleModalTitle').textContent = 'ğŸ‘¤ Remove Admin';
                document.getElementById('roleModalMessage').innerHTML = `
                    Remove admin privileges from <strong>${user.username}</strong>?<br>
                    <small style="color: #666;">They will no longer have access to this admin panel.</small>
                `;
            }
            
            document.getElementById('roleModal').classList.add('show');
        }
        
        // Confirm role change
        function confirmRoleChange() {
            const index = users.findIndex(u => u.id === changingRoleUserId);
            if (index !== -1) {
                users[index].role = newRole;
                localStorage.setItem('adminUsers', JSON.stringify(users));
            }
            
            closeRoleModal();
            loadUsers();
        }
        
        // Delete user
        function deleteUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            deletingUserId = userId;
            document.getElementById('deleteUserName').textContent = user.username;
            document.getElementById('deleteModal').classList.add('show');
        }
        
        // Confirm delete
        function confirmDelete() {
            users = users.filter(u => u.id !== deletingUserId);
            localStorage.setItem('adminUsers', JSON.stringify(users));
            closeDeleteModal();
            loadUsers();
        }
        
        // Close modals
        function closeRoleModal() {
            document.getElementById('roleModal').classList.remove('show');
            changingRoleUserId = null;
            newRole = null;
        }
        
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('show');
            deletingUserId = null;
        }
        
        // Helper function
        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
        
        // Sidebar toggle for mobile
        function initSidebarToggle() {
            const toggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('adminSidebar');
            
            toggle.addEventListener('click', () => {
                sidebar.classList.toggle('active');
                toggle.textContent = sidebar.classList.contains('active') ? 'âœ•' : 'â˜°';
            });
        }
        
        // Close modal on outside click
        document.getElementById('roleModal').addEventListener('click', (e) => {
            if (e.target.id === 'roleModal') closeRoleModal();
        });
        
        document.getElementById('deleteModal').addEventListener('click', (e) => {
            if (e.target.id === 'deleteModal') closeDeleteModal();
        });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadUsers();
            initSidebarToggle();
        });
    </script>
{% endblock %}