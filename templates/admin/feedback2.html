{% block scripts %}
<script>
    let feedbackList = [];
    let currentPage = 1;
    let totalPages = 1;
    let selectedFeedbackId = null;
    let deletingFeedbackId = null;
    
    // --- LOAD DATA ---
    async function loadFeedback() {
        const status = document.getElementById('filterStatus').value;
        const search = document.getElementById('searchFeedback').value.trim();
        
        let url = `/admin/api/feedback-list?page=${currentPage}&per_page=10`;
        if (status) url += `&status=${status}`;
        if (search) url += `&search=${encodeURIComponent(search)}`;

        try {
            const res = await fetch(url);
            const data = await res.json();
            
            feedbackList = data.feedback;
            totalPages = data.pages;
            
            // Update counts in the UI
            // Note: For full stats (Unread/Read counts), we'd usually reload the main stats API
            // but for now we update the list count
            document.getElementById('feedbackCount').textContent = `${data.total} messages`;
            
            // Update global stats if you want them to refresh (requires calling stats API)
            loadStats();

            renderFeedback(feedbackList);
            renderPagination(data.current_page, data.pages);
        } catch (err) {
            console.error("Error loading feedback:", err);
            Swal.fire('Error', 'Failed to load feedback', 'error');
        }
    }

    async function loadStats() {
        try {
            const res = await fetch('/admin/api/stats');
            const data = await res.json();
            
            if (res.ok && data.feedback) {
                // Update the stats cards with real numbers
                document.getElementById('totalFeedback').textContent = data.feedback.total;
                document.getElementById('unreadFeedback').textContent = data.feedback.unread;
                document.getElementById('readFeedback').textContent = data.feedback.read;
            }
        } catch (err) {
            console.error("Failed to load stats", err);
        }
    }

    function renderFeedback(feedbackToRender) {
        const container = document.getElementById('feedbackContainer');
        
        if (feedbackToRender.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ðŸ“­</div>
                    <h3>No Feedback Found</h3>
                    <p>No feedback matches your filter criteria.</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = feedbackToRender.map(fb => `
            <div class="feedback-card ${fb.status === 'unread' || fb.status === 'new' ? 'unread' : ''}" 
                 onclick="viewFeedback(${fb.id})" 
                 style="cursor: pointer; ${fb.status === 'unread' || fb.status === 'new' ? 'border-left: 4px solid #22c55e;' : ''}">
                <div class="feedback-header">
                    <div class="feedback-user">
                        <h4>${fb.name}</h4>
                        <p>${fb.email}</p>
                    </div>
                    <div class="feedback-meta">
                        <span class="badge ${fb.status === 'unread' || fb.status === 'new' ? 'badge-unread' : 'badge-read'}">
                            ${fb.status === 'new' ? 'Unread' : capitalizeFirst(fb.status)}
                        </span>
                        <div class="feedback-date">${fb.submitted_at}</div>
                    </div>
                </div>
                <div class="feedback-subject">${fb.subject}</div>
                <div class="feedback-message" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                    ${fb.message}
                </div>
            </div>
        `).join('');
    }

    // Since UI didn't have pagination buttons, we inject them dynamically at the bottom of container
    function renderPagination(current, total) {
        const container = document.getElementById('feedbackContainer');
        
        if (total > 1) {
            const paginationHTML = `
                <div style="margin-top: 20px; display: flex; justify-content: center; gap: 10px; padding-bottom: 20px;">
                    <button class="btn btn-secondary btn-sm" onclick="changePage(-1)" ${current <= 1 ? 'disabled' : ''}>Previous</button>
                    <span style="align-self: center;">Page ${current} of ${total}</span>
                    <button class="btn btn-secondary btn-sm" onclick="changePage(1)" ${current >= total ? 'disabled' : ''}>Next</button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', paginationHTML);
        }
    }

    function changePage(delta) {
        if (currentPage + delta > 0 && currentPage + delta <= totalPages) {
            currentPage += delta;
            loadFeedback();
        }
    }

    function filterFeedback() {
        currentPage = 1;
        loadFeedback();
    }

    // --- ACTIONS ---

    async function viewFeedback(id) {
        const fb = feedbackList.find(f => f.id === id);
        if (!fb) return;
        
        selectedFeedbackId = id;
        
        // 1. Mark as read in Backend if currently unread
        if (fb.status === 'unread' || fb.status === 'new') {
            try {
                await fetch(`/api/feedback/${id}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'read' })
                });
                // Update local list to reflect read status
                fb.status = 'read';
                loadFeedback(); // Refresh UI to remove "Unread" styling
            } catch (e) { console.error("Failed to mark read", e); }
        }
        
        const modalBody = document.getElementById('feedbackModalBody');
        modalBody.innerHTML = `
            <div style="margin-bottom: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                    <div>
                        <h4 style="font-size: 1.1rem; font-weight: 900; margin: 0 0 0.25rem 0;">${fb.name}</h4>
                        <p style="color: #666; font-size: 0.9rem; margin: 0;">${fb.email}</p>
                    </div>
                    <div style="text-align: right;">
                        <span class="badge badge-read">Read</span>
                        <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">${fb.submitted_at}</div>
                    </div>
                </div>
                <div style="font-size: 1.1rem; font-weight: 700; padding: 0.75rem 0; border-top: 2px solid #e0e0e0; border-bottom: 2px solid #e0e0e0;">
                    ${fb.subject}
                </div>
            </div>
            <div style="background: #f8f8f8; padding: 1.25rem; border: 2px solid #e0e0e0; line-height: 1.7;">
                ${fb.message}
            </div>
        `;
        
        document.getElementById('feedbackModal').classList.add('show');
    }

    async function markAllAsRead() {
        try {
            const res = await fetch('/admin/api/feedback/mark-all-read', { method: 'POST' });
            if (res.ok) {
                Swal.fire('Success', 'All feedback marked as read', 'success');
                loadFeedback();
            }
        } catch (err) {
            Swal.fire('Error', 'Failed to mark all as read', 'error');
        }
    }

    function deleteFeedback() {
        if (selectedFeedbackId) {
            deletingFeedbackId = selectedFeedbackId;
            closeFeedbackModal();
            document.getElementById('deleteModal').classList.add('show');
        }
    }

    async function confirmDelete() {
        if (!deletingFeedbackId) return;

        try {
            const res = await fetch(`/admin/api/feedback/${deletingFeedbackId}`, { method: 'DELETE' });
            if (res.ok) {
                Swal.fire('Deleted', 'Feedback deleted successfully', 'success');
                closeDeleteModal();
                loadFeedback();
            } else {
                throw new Error('Failed to delete');
            }
        } catch (err) {
            Swal.fire('Error', 'API Error', 'error');
        }
    }

    // --- UTILS ---
    function closeFeedbackModal() {
        document.getElementById('feedbackModal').classList.remove('show');
        selectedFeedbackId = null;
    }
    
    function closeDeleteModal() {
        document.getElementById('deleteModal').classList.remove('show');
        deletingFeedbackId = null;
    }

    function capitalizeFirst(str) {
        if (!str) return '';
        return str.charAt(0).toUpperCase() + str.slice(1);
    }

    // Close on outside click
    document.querySelectorAll('.admin-modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.classList.remove('show');
        });
    });

    // Init
    document.addEventListener('DOMContentLoaded', () => {
        loadFeedback();
    });
</script>
{% endblock %}