
{% extends "admin/layout.html" %}

{% block title %}Dashboard - Find the Word{% endblock %}

{% block header_title %}üìä Dashboard Words{% endblock %}
{% block header_subtitle %}Welcome back! Here is what's happening.{% endblock %}

{% block content %}
<!-- Header -->
<header class="admin-header">
    <div class="admin-header-left">
        <h1>üìù Words Management</h1>
        <p>Add, edit, and manage game words</p>
    </div>
    <div class="admin-header-right">
        <button class="btn btn-primary" onclick="openAddModal()">
            ‚ûï Add New Word
        </button>
    </div>
</header>

<!-- Filter Controls -->
<div class="filter-controls">
    <div class="filter-group">
        <label>Category:</label>
        <select class="filter-select" id="filterCategory" onchange="loadWords()">
            <option value="">All Categories</option>
            <option value="animals">Animals</option>
            <option value="nature">Nature</option>
            <option value="technology">Technology</option>
            <option value="food">Food</option>
            <option value="sports">Sports</option>
            <option value="colors">Colors</option>
            <option value="objects">Objects</option>
        </select>
    </div>
    <div class="filter-group">
        <label>Difficulty:</label>
        <select class="filter-select" id="filterDifficulty" onchange="loadWords()">
            <option value="">All Difficulties</option>
            <option value="easy">Easy</option>
            <option value="medium">Medium</option>
            <option value="hard">Hard</option>
        </select>
    </div>
    <div class="filter-group">
        <input type="text" class="search-input" id="searchWord" placeholder="Search words..." onchange="handleSearch()">
    </div>
</div>

<!-- Words Table -->
<div class="admin-panel">
    <div class="panel-header">
        <h2>üìö Word Library</h2>
        <span id="wordCount">Loading...</span>
    </div>
    <div class="panel-body">
        <table class="data-table" id="wordsTable">
            <thead>
                <tr>
                    <th>Word</th>
                    <th>Definition</th>
                    <th>Category</th>
                    <th>Difficulty</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="wordsTableBody">
                <!-- Words will be loaded here -->
            </tbody>
        </table>
        
        <div class="empty-state" id="emptyState" style="display: none;">
            <div class="empty-state-icon">üì≠</div>
            <h3>No Words Found</h3>
            <p>No words match your filter criteria.</p>
        </div>

        <div id="paginationControls" style="margin-top: 20px; display: flex; justify-content: center; gap: 10px;">
            <button class="btn btn-secondary btn-sm" id="prevPageBtn" onclick="changePage(-1)">Previous</button>
            <span id="pageInfo" style="align-self: center;">Page 1</span>
            <button class="btn btn-secondary btn-sm" id="nextPageBtn" onclick="changePage(1)">Next</button>
        </div>
    </div>
</div>
    
<!-- Add/Edit Word Modal -->
<div class="admin-modal" id="wordModal">
    <div class="admin-modal-content">
        <div class="admin-modal-header">
            <h3 id="modalTitle">Add New Word</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="admin-modal-body">
            <form id="wordForm">
                <input type="hidden" id="wordId">
                
                <div class="form-group">
                    <label for="wordInput">Word *</label>
                    <input type="text" id="wordInput" placeholder="Enter the word" required>
                </div>
                
                <div class="form-group">
                    <label for="definitionInput">Definition *</label>
                    <textarea id="definitionInput" placeholder="Enter the definition" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="exampleInput">Example Usage *</label>
                    <textarea id="exampleInput" placeholder="Enter an example sentence" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="triviaInput">Trivia</label>
                    <textarea id="triviaInput" placeholder="Enter fun facts or trivia (optional)"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="categoryInput">Category *</label>
                        <input type="text" name="category" id="categoryInput" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="difficultyInput">Difficulty *</label>
                        <select id="difficultyInput" required>
                            <option value="">Select Difficulty</option>
                            <option value="easy">Easy (3-4 letters)</option>
                            <option value="medium">Medium (5-6 letters)</option>
                            <option value="hard">Hard (7+ letters)</option>
                        </select>
                    </div>
                </div>
            </form>
        </div>
        <div class="admin-modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveWord()">Save Word</button>
        </div>
    </div>
</div>

<!-- View Word Details Modal -->
<div class="admin-modal" id="viewModal">
    <div class="admin-modal-content">
        <div class="admin-modal-header">
            <h3>üìñ Word Details</h3>
            <button class="modal-close" onclick="closeViewModal()">&times;</button>
        </div>
        <div class="admin-modal-body" id="viewModalBody">
            <p>Loading...</p>
        </div>
        <div class="admin-modal-footer">
            <button class="btn btn-secondary" onclick="closeViewModal()">Close</button>
            <button class="btn btn-primary" id="editFromViewBtn">Edit Word</button>
        </div>
    </div>
</div>
    
<!-- Delete Confirmation Modal -->
<div class="admin-modal" id="deleteModal">
    <div class="admin-modal-content" style="max-width: 400px;">
        <div class="admin-modal-header">
            <h3>‚ö†Ô∏è Delete Word</h3>
            <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
        </div>
        <div class="admin-modal-body">
            <p style="text-align: center; font-size: 1rem;">
                Are you sure you want to delete "<strong id="deleteWordName"></strong>"?
            </p>
            <p style="text-align: center; color: #666; font-size: 0.9rem;">
                This action cannot be undone.
            </p>
        </div>
        <div class="admin-modal-footer">
            <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
            <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
    <script>
        let words = [];
        let currentPage = 1;
        let totalPages = 1;
        let editingWordId = null;
        let deletingWordId = null;
        let viewingWordId = null;

        async function loadCategories() {
            try {
                const res = await fetch('/api/words/categories');
                const data = await res.json();
                console.log(data)
                
                // We need to update TWO dropdowns:
                // 1. The Filter Dropdown (top of page)
                const filterSelect = document.getElementById('filterCategory');
                // 2. The Form Dropdown (inside the modal)
                const formSelect = document.getElementById('categoryInput');

                // Clear current options (keep the first default one)
                filterSelect.innerHTML = '<option value="">All Categories</option>';
                formSelect.innerHTML = '<option value="">Select Category</option>';

                // Helper to create options
                data.categories.forEach(cat => {
                    // Formatting: "animals" -> "Animals"
                    const label = capitalizeFirst(cat); 
                    
                    // Add to Filter
                    const filterOption = document.createElement('option');
                    filterOption.value = cat;
                    filterOption.textContent = label;
                    filterSelect.appendChild(filterOption);

                    // Add to Form
                    const formOption = document.createElement('option');
                    formOption.value = cat;
                    formOption.textContent = label;
                    formSelect.appendChild(formOption);
                });

                

            } catch (err) {
                console.error("Failed to load categories:", err);
            }
        }
        
        async function loadWords() {
            const category = document.getElementById('filterCategory').value;
            const difficulty = document.getElementById('filterDifficulty').value;
            
            let url = `/api/words?page=${currentPage}&per_page=15`;
            if (category) url += `&category=${category}`;
            if (difficulty) url += `&difficulty=${difficulty}`;

            try {
                const res = await fetch(url);
                const data = await res.json();
                
                words = data.words;
                totalPages = data.pages;
                
                document.getElementById('pageInfo').textContent = `Page ${data.current_page} of ${data.pages}`;
                document.getElementById('prevPageBtn').disabled = data.current_page <= 1;
                document.getElementById('nextPageBtn').disabled = data.current_page >= data.pages;

                renderWords(words);
            } catch (err) {
                console.error("Error loading words:", err);
                Swal.fire('Error', 'Failed to load words', 'error');
            }
        }

        async function handleSearch() {
            const query = document.getElementById('searchWord').value.trim();
            if (!query) {
                loadWords(); // Reload all if search cleared
                return;
            }

            try {
                // Your API uses exact match search
                const res = await fetch(`/api/words/search?word=${query}`);
                if (!res.ok) throw new Error('Word not found');
                
                const word = await res.json();
                renderWords([word]); // Render array with single result
                
                document.getElementById('pageInfo').textContent = "Search Result";
                document.getElementById('prevPageBtn').disabled = true;
                document.getElementById('nextPageBtn').disabled = true;
            } catch (err) {
                document.getElementById('wordsTableBody').innerHTML = '';
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('wordsTable').style.display = 'none';
                document.getElementById('wordCount').textContent = "0 words";
            }
        }

        function changePage(delta) {
            if (currentPage + delta > 0 && currentPage + delta <= totalPages) {
                currentPage += delta;
                loadWords();
            }
        }
        
        // Render words to table
        function renderWords(wordsToRender) {
            const tbody = document.getElementById('wordsTableBody');
            const emptyState = document.getElementById('emptyState');
            const wordCount = document.getElementById('wordCount');
            
            wordCount.textContent = `${wordsToRender.length} words shown`;
            
            if (wordsToRender.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                document.getElementById('wordsTable').style.display = 'none';
                return;
            }
            
            emptyState.style.display = 'none';
            document.getElementById('wordsTable').style.display = 'table';
            
            tbody.innerHTML = wordsToRender.map(word => `
                <tr>
                    <td><strong style="cursor: pointer; color: #22c55e;" onclick="viewWord(${word.id})">${word.word}</strong></td>
                    <td class="text-truncate" style="max-width: 200px;">${word.definition || '-'}</td>
                    <td>${capitalizeFirst(word.category || 'General')}</td>
                    <td><span class="badge badge-${word.difficulty}">${capitalizeFirst(word.difficulty)}</span></td>
                    <td>
                        <div class="table-actions">
                            <button class="action-btn" onclick="viewWord(${word.id})" title="View Details">üëÅÔ∏è</button>
                            <button class="action-btn edit" onclick="editWord(${word.id})" title="Edit">‚úèÔ∏è</button>
                            <button class="action-btn delete" onclick="deleteWord(${word.id})" title="Delete">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // --- ACTIONS (ADD / EDIT / DELETE) ---
        async function saveWord() {
            const wordInput = document.getElementById('wordInput').value.trim();
            const definition = document.getElementById('definitionInput').value.trim();
            const category = document.getElementById('categoryInput').value;
            const difficulty = document.getElementById('difficultyInput').value;
            const example = document.getElementById('exampleInput').value;
            const trivia = document.getElementById('triviaInput').value;
            
            if (!wordInput || !definition || !category || !difficulty) {
                Swal.fire('Error', 'Please fill in all required fields.', 'warning');
                return;
            }

            const payload = {
                word: wordInput,
                definition: definition,
                category: category,
                difficulty: difficulty,
                example: example,
                trivia: trivia
                // Example/Trivia omitted as not in DB model provided
            };

            const url = editingWordId ? `/api/words/${editingWordId}` : '/api/words/';
            const method = editingWordId ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();

                if (res.ok) {
                    Swal.fire('Success', data.message, 'success');
                    closeModal();
                    loadWords();
                    loadCategories();
                } else {
                    throw new Error(data.error || 'Failed to save');
                }
            } catch (err) {
                Swal.fire('Error', err.message, 'error');
            }
        }

        async function confirmDelete() {
            if (!deletingWordId) return;

            try {
                const res = await fetch(`/api/words/${deletingWordId}`, { method: 'DELETE' });
                const data = await res.json();

                if (res.ok) {
                    Swal.fire('Deleted!', data.message, 'success');
                    closeDeleteModal();
                    loadWords();
                } else {
                    throw new Error(data.error || 'Failed to delete');
                }
            } catch (err) {
                Swal.fire('Error', err.message, 'error');
            }
        }
        
        // Open add modal
        function openAddModal() {
            editingWordId = null;
            document.getElementById('modalTitle').textContent = 'Add New Word';
            document.getElementById('wordForm').reset();
            document.getElementById('wordModal').classList.add('show');
        }
        
        // Edit word
        async function editWord(id) {
            editingWordId = id;
            document.getElementById('modalTitle').textContent = 'Edit Word';
            
            try {
                const res = await fetch(`/api/words/${id}`);
                const word = await res.json();

                document.getElementById('wordInput').value = word.word;
                document.getElementById('definitionInput').value = word.definition;
                document.getElementById('categoryInput').value = word.category;
                document.getElementById('difficultyInput').value = word.difficulty;
                document.getElementById('exampleInput').value = word.example;
                document.getElementById('triviaInput').value = word.trivia;
                
                document.getElementById('wordModal').classList.add('show');
            } catch (err) {
                Swal.fire('Error', 'Could not fetch word details', 'error');
            }
        }

        async function viewWord(id) {
            viewingWordId = id;
            const modalBody = document.getElementById('viewModalBody');
            modalBody.innerHTML = '<p>Loading...</p>';
            document.getElementById('viewModal').classList.add('show');

            try {
                const res = await fetch(`/api/words/${id}`);
                const word = await res.json();

                modalBody.innerHTML = `
                    <div style="margin-bottom: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h2 style="font-size: 1.75rem; font-weight: 900; margin: 0;">${word.word}</h2>
                            <div>
                                <span class="badge badge-${word.difficulty}">${capitalizeFirst(word.difficulty)}</span>
                                <span class="badge" style="background: #f8f8f8; color: #000; border-color: #000; margin-left: 0.5rem;">${capitalizeFirst(word.category)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #f8f8f8; border: 2px solid #000; padding: 1.25rem; margin-bottom: 1rem;">
                        <div style="font-weight: 900; text-transform: uppercase; font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">üìñ Definition</div>
                        <p style="margin: 0; line-height: 1.6;">${word.definition}</p>
                    </div>
                    
                    <div style="background: #f8f8f8; border: 2px solid #000; padding: 1.25rem; margin-bottom: 1rem;">
                        <div style="font-weight: 900; text-transform: uppercase; font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">üí¨ Example Usage</div>
                        <p style="margin: 0; line-height: 1.6; font-style: italic;">"${word.example}"</p>
                    </div>
                    
                    ${word.trivia ? `
                    <div style="background: #22c55e15; border: 2px solid #22c55e; padding: 1.25rem;">
                        <div style="font-weight: 900; text-transform: uppercase; font-size: 0.8rem; color: #22c55e; margin-bottom: 0.5rem;">üí° Trivia</div>
                        <p style="margin: 0; line-height: 1.6;">${word.trivia}</p>
                    </div>
                    ` : `
                    <div style="background: #f0f0f0; border: 2px solid #e0e0e0; padding: 1.25rem; text-align: center; color: #999;">
                        <em>No trivia available for this word.</em>
                    </div>
                    `}
                `;
            } catch (err) {
                modalBody.innerHTML = '<p class="text-red-500">Failed to load word details.</p>';
            }
        }
        
        // Delete word
        function deleteWord(id) {
            // Find word in local list just to get the name for the prompt
            const word = words.find(w => w.id === id);
            deletingWordId = id;
            document.getElementById('deleteWordName').textContent = word ? word.word : 'this word';
            document.getElementById('deleteModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('wordModal').classList.remove('show');
            editingWordId = null;
        }

        function closeViewModal() {
            document.getElementById('viewModal').classList.remove('show');
            viewingWordId = null;
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('show');
            deletingWordId = null;
        }
        
        document.getElementById('editFromViewBtn').addEventListener('click', () => {
            if (viewingWordId) {
                closeViewModal();
                editWord(viewingWordId);
            }
        });

        // Close on outside click
        document.querySelectorAll('.admin-modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.classList.remove('show');
            });
        });

        
        function capitalizeFirst(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadWords();
            loadCategories();
        });
    </script>

{% endblock %}