{% extends "base.html" %}
{% block title %}Find the Word - Leaderboard{% endblock %}


{% block content %}
    <div class="leaderboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="dashboard-logo">
                <div class="logo-box">F</div>
                <h1 class="dashboard-title">FIND THE WORD</h1>
            </div>
            <div class="header-actions">
                <button class="back-to-dashboard-btn" onclick="window.location.href='game'">‚Üê BACK TO DASHBOARD</button>
                <div class="user-info">
                    <div class="user-avatar" id="playerLogo">P</div>
                    <span class="user-name" id="playerUsername">Player</span>
                </div>
            </div>
        </header>

        <!-- Leaderboard Section -->
        <section class="full-leaderboard-section">
            <h2>üìä LEADERBOARD</h2>
            <div class="scroll-hint">Scroll to see more</div>
            <div class="leaderboard-table-wrapper">
            <div class="leaderboard-table">
                <div class="leaderboard-row header">
                    <div class="rank">Rank</div>
                    <div class="player-name">Player</div>
                    <div class="player-score">Total Score</div>
                    <div class="player-games">Games</div>
                    <div class="player-time">Avg Time</div>
                </div>
                <!-- Top Players (Mock Data) -->
                <div class="leaderboard-row">
                    <div class="rank top medal-gold">1</div>
                    <div class="player-name">WordMaster99</div>
                    <div class="player-score">2,450</div>
                    <div class="player-games">45</div>
                    <div class="player-time">01:23</div>
                </div>

                <!-- Current Player Row (Dynamically positioned) -->
                <div class="leaderboard-row current-player" id="currentPlayerRow">
                    <div class="rank" id="currentPlayerRank">--</div>
                    <div class="player-name"><span id="currentPlayerName">Player</span> (You)</div>
                    <div class="player-score" id="currentPlayerScore">0</div>
                    <div class="player-games" id="currentPlayerGames">0</div>
                    <div class="player-time" id="currentPlayerTime">--:--</div>
                </div>
            </div>
            </div><!-- End of leaderboard-table-wrapper -->
            
            <!-- Pagination Controls -->
            <div class="pagination-controls">
                <button class="pagination-btn" id="prevPageBtn" onclick="changePage(-1)" disabled>
                    ‚Üê Previous
                </button>
                <div class="pagination-info">
                    <span>Page <strong id="currentPageNum">1</strong> of <strong id="totalPagesNum">1</strong></span>
                    <span class="pagination-entries">(<span id="showingStart">0</span>-<span id="showingEnd">0</span> of <span id="totalEntries">0</span>)</span>
                </div>
                <button class="pagination-btn" id="nextPageBtn" onclick="changePage(1)" disabled>
                    Next ‚Üí
                </button>
            </div>
        </section>
    </div>

{% endblock %}

{% block scripts %}
    <script>
        async function apiCall(url, options = {}) {
            const res = await fetch(url, {
                method: options.method || 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                },
                body: options.body ? JSON.stringify(options.body) : null,
                credentials: 'include'  // Crucial for Flask-Login session
            });

            const data = await res.json();

            if (!res.ok) {
                throw new Error(data.error || data.message || 'Something went wrong');
            }

            return data;
        }
        async function loadPlayerStats() {
            try {
                const stats = await apiCall('/api/leaderboard/user-stats');
                console.log(stats)
                document.getElementById('playerUsername').textContent = stats.username || 'Guest';
                document.getElementById('playerLogo').textContent = stats.username.trim().charAt(0).toUpperCase() || 'P';

            } catch (err) {
                console.error('Failed to load player stats:', err);
                // Keep defaults (0s) if offline or error
            }
        }

        function formatTime(seconds) {
            if (!seconds || seconds <= 0) return '--:--';

            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);  // ‚Üê FLOOR IT! No decimals!

            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // ===== PAGINATION STATE =====
        let allLeaderboardData = [];
        let currentPage = 1;
        const ITEMS_PER_PAGE = 10;
        let totalPages = 1;
        let headerRowRef = null; // Store header reference

        async function loadLeaderboard() {
            try {
                const data = await apiCall('/api/leaderboard/leaderboard?limit=50'); // Get top 50
                allLeaderboardData = data.leaderboard || [];
                
                const tableBody = document.querySelector('.leaderboard-table');
                headerRowRef = tableBody.querySelector('.leaderboard-row.header').cloneNode(true);
                
                // Calculate total pages
                totalPages = Math.ceil(allLeaderboardData.length / ITEMS_PER_PAGE);
                if (totalPages === 0) totalPages = 1;
                
                // Reset to page 1 and render
                currentPage = 1;
                renderPage();
                
                // If current user is not in the data, show them separately
                if (!allLeaderboardData.some(p => p.is_current_user)) {
                    await showCurrentPlayerOutsideTop();
                }

            } catch (err) {
                console.error('Failed to load leaderboard:', err);
                showNotification('Failed to load leaderboard');
            }
        }

        function renderPage() {
            const tableBody = document.querySelector('.leaderboard-table');
            
            // Clear table and re-add header
            tableBody.innerHTML = '';
            tableBody.appendChild(headerRowRef.cloneNode(true));
            
            // Calculate slice for current page
            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, allLeaderboardData.length);
            const pageData = allLeaderboardData.slice(startIndex, endIndex);
            
            // Render rows for this page
            pageData.forEach((entry, pageIndex) => {
                const rank = startIndex + pageIndex + 1; // Overall rank
                const isTop3 = rank <= 3;
                const medalClass = rank === 1 ? 'medal-gold' : rank === 2 ? 'medal-silver' : rank === 3 ? 'medal-bronze' : '';

                const row = document.createElement('div');
                row.className = `leaderboard-row ${entry.is_current_user ? 'current-player' : ''}`;
                row.innerHTML = `
                    <div class="rank ${isTop3 ? 'top ' + medalClass : ''}">${rank}</div>
                    <div class="player-name">
                        ${entry.username}
                        ${entry.is_current_user ? ' <span style="color:#00d4ff;font-weight:bold">(You)</span>' : ''}
                    </div>
                    <div class="player-score">${entry.score.toLocaleString()}</div>
                    <div class="player-games">${entry.games_played || entry.total_games || 0}</div>
                    <div class="player-time">${formatTime(entry.avg_time || entry.average_time)}</div>
                `;
                tableBody.appendChild(row);
            });
            
            // Update pagination UI
            updatePaginationUI(startIndex + 1, endIndex);
        }

        function changePage(direction) {
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderPage();
                
                // Scroll to top of leaderboard section
                document.querySelector('.full-leaderboard-section').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }
        }

        function updatePaginationUI(showStart, showEnd) {
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            const currentPageNum = document.getElementById('currentPageNum');
            const totalPagesNum = document.getElementById('totalPagesNum');
            const showingStartEl = document.getElementById('showingStart');
            const showingEndEl = document.getElementById('showingEnd');
            const totalEntriesEl = document.getElementById('totalEntries');
            
            // Update page numbers
            currentPageNum.textContent = currentPage;
            totalPagesNum.textContent = totalPages;
            
            // Update entries info
            showingStartEl.textContent = allLeaderboardData.length > 0 ? showStart : 0;
            showingEndEl.textContent = showEnd;
            totalEntriesEl.textContent = allLeaderboardData.length;
            
            // Enable/disable buttons
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;
        }

        async function showCurrentPlayerOutsideTop() {
        try {
            const stats = await apiCall('/api/leaderboard/user-stats');
            const row = document.createElement('div');
            row.className = 'leaderboard-row current-player';
            row.id = 'currentPlayerRow';
            row.innerHTML = `
                <div class="rank">--</div>
                <div class="player-name">${stats.username} <span style="color:#00d4ff;font-weight:bold">(You)</span></div>
                <div class="player-score">${(stats.total_score && Object.values(stats.total_score).length > 0
                    ? Math.max(...Object.values(stats.total_score).map(s => s.score || 0))
                    : 0).toLocaleString()}</div>
                <div class="player-games">${stats.total_games || 0}</div>
                <div class="player-time">--:--</div>
            `;
            document.querySelector('.leaderboard-table').appendChild(row);
        } catch (err) {
            console.error('Could not load current user stats');
        }
    }

    // Update header (username + avatar)
    async function updateHeader() {
        try {
            const stats = await apiCall('/api/leaderboard/user-stats');
            document.getElementById('playerUsername').textContent = stats.username || 'Guest';
            document.getElementById('playerLogo').textContent = (stats.username || 'G').charAt(0).toUpperCase();
        } catch (err) {
            document.getElementById('playerUsername').textContent = 'Guest';
            document.getElementById('playerLogo').textContent = 'G';
        }
    }

    // Notification helper (same as game page)
    function showNotification(msg, duration = 4000) {
        let alert = document.getElementById('notificationAlert');
        if (!alert) {
            alert = document.createElement('div');
            alert.id = 'notificationAlert';
            alert.className = 'notification-alert';
            alert.innerHTML = '<span id="notificationMessage"></span>';
            document.body.appendChild(alert);
        }
        document.getElementById('notificationMessage').textContent = msg;
        alert.classList.add('show');
        setTimeout(() => alert.classList.remove('show'), duration);
    }

    // Load everything on page load
    document.addEventListener('DOMContentLoaded', () => {
        updateHeader();
        loadLeaderboard();

    });

    </script>

{% endblock %}
